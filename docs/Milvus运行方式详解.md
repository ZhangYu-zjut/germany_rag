# Milvus è¿è¡Œæ–¹å¼è¯¦è§£ & Collection æ¦‚å¿µè¯´æ˜

## ğŸ“š ç›®å½•
1. [Milvus æ˜¯ä»€ä¹ˆï¼Ÿ](#1-milvus-æ˜¯ä»€ä¹ˆ)
2. [Collection æ˜¯ä»€ä¹ˆï¼Ÿ](#2-collection-æ˜¯ä»€ä¹ˆ)
3. [ä¸‰ç§è¿è¡Œæ–¹å¼å¯¹æ¯”](#3-ä¸‰ç§è¿è¡Œæ–¹å¼å¯¹æ¯”)
4. [æ¨èï¼šä½¿ç”¨ Milvus Lite (æ— éœ€ Docker)](#4-æ¨èä½¿ç”¨-milvus-lite-æ— éœ€-docker)
5. [è¯¦ç»†ä½¿ç”¨æŒ‡å—](#5-è¯¦ç»†ä½¿ç”¨æŒ‡å—)

---

## 1ï¸âƒ£ Milvus æ˜¯ä»€ä¹ˆï¼Ÿ

**Milvus** æ˜¯ä¸€ä¸ªå¼€æºçš„**å‘é‡æ•°æ®åº“**ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢é«˜ç»´å‘é‡æ•°æ®ã€‚

### ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ

åœ¨æˆ‘ä»¬çš„å¾·å›½è®®ä¼šæ™ºèƒ½é—®ç­”ç³»ç»Ÿä¸­ï¼š

```
ç”¨æˆ·é—®é¢˜: "2019å¹´å¾·å›½è”é‚¦è®®é™¢è®¨è®ºäº†å“ªäº›ä¸»è¦è®®é¢˜?"
           â†“
    è½¬æ¢ä¸ºå‘é‡(Embedding)
           â†“
    [0.1, 0.3, -0.2, ..., 0.5]  (1536ç»´å‘é‡)
           â†“
    åœ¨Milvusä¸­æœç´¢ç›¸ä¼¼å‘é‡
           â†“
    æ‰¾åˆ°æœ€ç›¸å…³çš„æ¼”è®²è®°å½•
           â†“
    è¿”å›ç­”æ¡ˆ
```

**ä¼ ç»Ÿæ•°æ®åº“** (MySQL, PostgreSQL)ï¼š
- âŒ åªèƒ½ç²¾ç¡®åŒ¹é…å…³é”®è¯
- âŒ æ— æ³•ç†è§£è¯­ä¹‰
- âŒ æœç´¢ "æ°”å€™ä¿æŠ¤" ä¸ä¼šæ‰¾åˆ° "ç¯å¢ƒæ”¿ç­–"

**å‘é‡æ•°æ®åº“** (Milvus)ï¼š
- âœ… ç†è§£è¯­ä¹‰ç›¸ä¼¼æ€§
- âœ… æœç´¢ "æ°”å€™ä¿æŠ¤" å¯ä»¥æ‰¾åˆ° "ç¯å¢ƒæ”¿ç­–"ã€"ç¢³æ’æ”¾"
- âœ… é€Ÿåº¦å¿«ï¼Œæ”¯æŒäº¿çº§å‘é‡æ£€ç´¢

---

## 2ï¸âƒ£ Collection æ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸ“¦ Collection = è¡¨æ ¼ (ç±»æ¯”ä¼ ç»Ÿæ•°æ®åº“)

åœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸­ï¼š
```
æ•°æ®åº“ (Database)
  â””â”€â”€ è¡¨ (Table)
       â”œâ”€â”€ åˆ— (Column)
       â””â”€â”€ è¡Œ (Row)
```

åœ¨ Milvus ä¸­ï¼š
```
Milvus
  â””â”€â”€ Collection (ç±»ä¼¼è¡¨)
       â”œâ”€â”€ å­—æ®µ (Field)
       â”‚    â”œâ”€â”€ id (ä¸»é”®)
       â”‚    â”œâ”€â”€ vector (å‘é‡å­—æ®µï¼Œ1536ç»´)
       â”‚    â”œâ”€â”€ text (æ–‡æœ¬å†…å®¹)
       â”‚    â”œâ”€â”€ year (å¹´ä»½)
       â”‚    â”œâ”€â”€ speaker (å‘è¨€äºº)
       â”‚    â””â”€â”€ group (å…šæ´¾)
       â””â”€â”€ å®ä½“ (Entityï¼Œç±»ä¼¼è¡Œ)
```

### ğŸ¯ æˆ‘ä»¬çš„ Collection

**åç§°**: `parliament_speeches` (å¾·å›½è®®ä¼šæ¼”è®²)

**åŒ…å«å†…å®¹**:
```python
{
    "id": 1,
    "vector": [0.1, 0.3, -0.2, ..., 0.5],  # 1536ç»´å‘é‡
    "text": "æˆ‘ä»¬ä»Šå¤©è®¨è®ºæ°”å€™ä¿æŠ¤æ”¿ç­–...",
    "year": "2019",
    "month": "03",
    "day": "15",
    "speaker": "Merkel",
    "group": "CDU/CSU",
    "group_chinese": "åŸºæ°‘ç›Ÿ/åŸºç¤¾ç›Ÿ",
    # ... æ›´å¤šå­—æ®µ
}
```

### ğŸ“Š Collection çš„ä½œç”¨

1. **ç»„ç»‡æ•°æ®**: å°†æ‰€æœ‰æ¼”è®²å‘é‡ç»„ç»‡åœ¨ä¸€èµ·
2. **å®šä¹‰ç»“æ„**: è§„å®šæ¯æ¡è®°å½•åŒ…å«å“ªäº›å­—æ®µ
3. **åˆ›å»ºç´¢å¼•**: å»ºç«‹ç´¢å¼•åŠ é€Ÿå‘é‡æ£€ç´¢
4. **æ”¯æŒæŸ¥è¯¢**: æ”¯æŒå‘é‡æ£€ç´¢å’Œå…ƒæ•°æ®è¿‡æ»¤

---

## 3ï¸âƒ£ ä¸‰ç§è¿è¡Œæ–¹å¼å¯¹æ¯”

### æ–¹å¼ä¸€ï¼šMilvus Lite â­ **æ¨èç”¨äºå¼€å‘**

```
ä¼˜ç‚¹:
âœ… æ— éœ€ Docker
âœ… å®‰è£…ç®€å• (pip install milvus-lite)
âœ… å¯åŠ¨å¿«é€Ÿ
âœ… é€‚åˆå¼€å‘å’Œæµ‹è¯•
âœ… æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶

ç¼ºç‚¹:
âš ï¸ æ€§èƒ½ä¸å¦‚å®Œæ•´ç‰ˆ
âš ï¸ åŠŸèƒ½ç•¥æœ‰é™åˆ¶
âš ï¸ ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
```

**é€‚ç”¨åœºæ™¯**:
- æœ¬åœ°å¼€å‘
- åŠŸèƒ½æµ‹è¯•
- å¿«é€ŸåŸå‹éªŒè¯
- ä¸ªäººå­¦ä¹ 

### æ–¹å¼äºŒï¼šMilvus Standalone (Docker) ğŸ³

```
ä¼˜ç‚¹:
âœ… åŠŸèƒ½å®Œæ•´
âœ… æ€§èƒ½ä¼˜ç§€
âœ… é€‚åˆä¸­å°è§„æ¨¡ç”Ÿäº§
âœ… æ˜“äºéƒ¨ç½²

ç¼ºç‚¹:
âš ï¸ éœ€è¦ Docker ç¯å¢ƒ
âš ï¸ éœ€è¦æ›´å¤šèµ„æº
âš ï¸ å¯åŠ¨ç¨æ…¢
```

**é€‚ç”¨åœºæ™¯**:
- ä¸­å°è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ
- å›¢é˜Ÿå¼€å‘
- æ€§èƒ½æµ‹è¯•

### æ–¹å¼ä¸‰ï¼šMilvus Cloud â˜ï¸

```
ä¼˜ç‚¹:
âœ… æ— éœ€ç®¡ç†æœåŠ¡å™¨
âœ… è‡ªåŠ¨æ‰©å±•
âœ… é«˜å¯ç”¨æ€§
âœ… é€‚åˆå¤§è§„æ¨¡ç”Ÿäº§

ç¼ºç‚¹:
âš ï¸ éœ€è¦ä»˜è´¹
âš ï¸ ä¾èµ–ç½‘ç»œ
âš ï¸ é…ç½®å¤æ‚
```

**é€‚ç”¨åœºæ™¯**:
- å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ
- éœ€è¦é«˜å¯ç”¨
- æ•°æ®é‡å·¨å¤§

---

## 4ï¸âƒ£ æ¨èï¼šä½¿ç”¨ Milvus Lite (æ— éœ€ Docker)

### ğŸ“ é…ç½®æ­¥éª¤

#### ç¬¬ 1 æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
# é‡æ–°å®‰è£…ä¾èµ–ï¼ˆå·²åŒ…å« milvus-liteï¼‰
pip install -r requirements.txt
```

#### ç¬¬ 2 æ­¥ï¼šä¿®æ”¹ `.env` é…ç½®

`.env` æ–‡ä»¶å·²ç»è‡ªåŠ¨æ›´æ–°ä¸ºï¼š

```bash
# Milvusæ¨¡å¼: lite/local/cloud
MILVUS_MODE=lite  # âœ… ä½¿ç”¨ Milvus Lite

# Milvus Liteé…ç½®(æ— éœ€Docker)
MILVUS_LITE_PATH=./milvus_data/milvus_lite.db
```

#### ç¬¬ 3 æ­¥ï¼šè¿è¡Œç³»ç»Ÿ

```bash
# ç›´æ¥è¿è¡Œï¼Œæ— éœ€å¯åŠ¨ Docker
python build_index.py  # æ„å»ºç´¢å¼•
python main.py          # å¯åŠ¨é—®ç­”ç³»ç»Ÿ
```

### ğŸ‰ å°±è¿™ä¹ˆç®€å•ï¼

ä¸éœ€è¦ï¼š
- âŒ å®‰è£… Docker
- âŒ å¯åŠ¨ Milvus å®¹å™¨
- âŒ é…ç½®ç«¯å£æ˜ å°„
- âŒ ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ

åªéœ€è¦ï¼š
- âœ… å®‰è£… Python åŒ…
- âœ… è¿è¡Œ Python è„šæœ¬

---

## 5ï¸âƒ£ è¯¦ç»†ä½¿ç”¨æŒ‡å—

### ğŸš€ å®Œæ•´æµç¨‹æ¼”ç¤º

#### åœºæ™¯ï¼šä»é›¶å¼€å§‹ä½¿ç”¨ Milvus Lite

```bash
# 1. ç¡®ä¿å·²å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. æ£€æŸ¥é…ç½®
cat .env | grep MILVUS_MODE
# è¾“å‡ºåº”è¯¥æ˜¯: MILVUS_MODE=lite

# 3. è¿è¡Œç¯å¢ƒæ£€æŸ¥
python check_env.py

# 4. æ„å»ºç´¢å¼•ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
python build_index.py
```

**build_index.py åšäº†ä»€ä¹ˆï¼Ÿ**

```
1. åŠ è½½æ•°æ® (pp_2019.json, pp_2020.json, pp_2021.json)
   â†“
2. æ–‡æœ¬åˆ†å— (1000å­—ç¬¦/chunk)
   â†“
3. ç”Ÿæˆå‘é‡ (ä½¿ç”¨ Gemini Embedding)
   â†“
4. åˆ›å»º Collection (parliament_speeches)
   â†“
5. æ’å…¥å‘é‡åˆ° Milvus Lite
   â†“
6. åˆ›å»ºç´¢å¼• (åŠ é€Ÿæ£€ç´¢)
   â†“
å®Œæˆï¼æ•°æ®å­˜å‚¨åœ¨: ./milvus_data/milvus_lite.db
```

#### è¿è¡Œä¸»ç¨‹åº

```bash
python main.py
```

**è¾“å‡ºç¤ºä¾‹**:

```
æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...
[Workflow] å¼€å§‹åˆå§‹åŒ–å·¥ä½œæµ...
è¿æ¥Milvus Lite: ./milvus_data/milvus_lite.db
Milvusè¿æ¥æˆåŠŸ: mode=lite
Collectionå­˜åœ¨ (åŒ…å«2156æ¡è®°å½•)
âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ

è¯·è¾“å…¥é—®é¢˜: 2019å¹´å¾·å›½è”é‚¦è®®é™¢è®¨è®ºäº†å“ªäº›ä¸»è¦è®®é¢˜?

æ­£åœ¨å¤„ç†æ‚¨çš„é—®é¢˜...
[IntentNode] åˆ¤æ–­ç»“æœ - æ„å›¾: simple
[RetrieveNode] æ£€ç´¢é—®é¢˜: 2019å¹´å¾·å›½è”é‚¦è®®é™¢è®¨è®ºäº†å“ªäº›ä¸»è¦è®®é¢˜?
[RetrieveNode] æ‰¾åˆ° 5 ä¸ªç›¸å…³chunks
[SummarizeNode] æ€»ç»“å®Œæˆ

ç­”æ¡ˆ:
æ ¹æ®æ£€ç´¢åˆ°çš„ææ–™,2019å¹´å¾·å›½è”é‚¦è®®é™¢è®¨è®ºçš„ä¸»è¦è®®é¢˜åŒ…æ‹¬:
1. æ°”å€™ä¿æŠ¤æ”¿ç­–
2. æ•°å­—åŒ–è½¬å‹
3. ç¤¾ä¼šå…¬å¹³ä¸å…»è€é‡‘æ”¹é©
...
```

---

### ğŸ“Š æ•°æ®å­˜å‚¨ä½ç½®

#### Milvus Lite æ¨¡å¼

```
é¡¹ç›®ç›®å½•/
â”œâ”€â”€ milvus_data/           # âœ… Milvus Lite æ•°æ®ç›®å½•
â”‚   â””â”€â”€ milvus_lite.db    # å‘é‡æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ data/
â”‚   â””â”€â”€ pp_json_49-21/    # åŸå§‹ JSON æ•°æ®
â””â”€â”€ logs/
    â””â”€â”€ app.log           # æ—¥å¿—æ–‡ä»¶
```

**æŸ¥çœ‹æ•°æ®åº“å¤§å°**:
```bash
# Windows PowerShell
Get-ChildItem -Recurse milvus_data | Measure-Object -Property Length -Sum

# Linux/Mac
du -sh milvus_data/
```

---

### ğŸ”„ åˆ‡æ¢è¿è¡Œæ¨¡å¼

#### ä» Milvus Lite åˆ‡æ¢åˆ° Docker

```bash
# 1. ä¿®æ”¹ .env
MILVUS_MODE=local  # æ”¹ä¸º local

# 2. å¯åŠ¨ Docker Milvus
docker run -d --name milvus -p 19530:19530 milvusdb/milvus:latest

# 3. é‡æ–°æ„å»ºç´¢å¼•
python build_index.py
```

#### ä» Docker åˆ‡æ¢å› Milvus Lite

```bash
# 1. ä¿®æ”¹ .env
MILVUS_MODE=lite  # æ”¹ä¸º lite

# 2. é‡æ–°è¿è¡Œï¼ˆæ— éœ€ Dockerï¼‰
python main.py
```

---

### ğŸ§ª æµ‹è¯•ä¸åŒæ¨¡å¼

#### æµ‹è¯•è„šæœ¬

åˆ›å»º `test_milvus_modes.py`:

```python
"""æµ‹è¯•ä¸åŒ Milvus æ¨¡å¼"""

from src.vectordb import MilvusClient
from src.config import settings

def test_connection():
    print(f"å½“å‰æ¨¡å¼: {settings.milvus_mode}")
    print(f"è¿æ¥URI: {settings.milvus_uri}")
    
    try:
        with MilvusClient() as client:
            collections = client.list_collections()
            print(f"âœ… è¿æ¥æˆåŠŸ")
            print(f"Collections: {collections}")
    except Exception as e:
        print(f"âŒ è¿æ¥å¤±è´¥: {e}")

if __name__ == "__main__":
    test_connection()
```

è¿è¡Œæµ‹è¯•:
```bash
python test_milvus_modes.py
```

---

### ğŸ“– å¸¸è§é—®é¢˜è§£ç­”

#### Q1: Milvus Lite æ€§èƒ½å¦‚ä½•ï¼Ÿ

**ç­”**: 
- å°æ•°æ®é‡(<10ä¸‡å‘é‡): â­â­â­â­â­ ä¼˜ç§€
- ä¸­ç­‰æ•°æ®é‡(10-100ä¸‡): â­â­â­â­ è‰¯å¥½
- å¤§æ•°æ®é‡(>100ä¸‡): â­â­â­ ä¸€èˆ¬ï¼ˆå»ºè®®ç”¨ Dockerï¼‰

æˆ‘ä»¬çš„é¡¹ç›®ï¼ˆ2.1ä¸‡æ¡è®°å½•ï¼‰ä½¿ç”¨ Milvus Lite **å®Œå…¨å¤Ÿç”¨**ï¼

#### Q2: Milvus Lite çš„æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ

**ç­”**: ä¸ä¼šï¼æ•°æ®æŒä¹…åŒ–å­˜å‚¨åœ¨ `./milvus_data/milvus_lite.db`

#### Q3: å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šç§æ¨¡å¼å—ï¼Ÿ

**ç­”**: ä¸å»ºè®®ã€‚æ¯ç§æ¨¡å¼çš„æ•°æ®æ˜¯ç‹¬ç«‹çš„ï¼Œåˆ‡æ¢æ¨¡å¼åéœ€è¦é‡æ–°æ„å»ºç´¢å¼•ã€‚

#### Q4: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ

**Milvus Lite**:
```bash
# å¤‡ä»½æ•°æ®åº“æ–‡ä»¶
cp -r milvus_data milvus_data_backup

# æ¢å¤
cp -r milvus_data_backup milvus_data
```

**Docker Milvus**:
```bash
# å¯¼å‡ºæ•°æ®
docker exec milvus milvus-backup create

# æ¢å¤æ•°æ®
docker exec milvus milvus-backup restore
```

#### Q5: å¦‚ä½•åˆ é™¤ Collectionï¼Ÿ

```python
from pymilvus import utility, connections
from src.config import settings

# è¿æ¥
connections.connect(uri=settings.milvus_uri)

# åˆ é™¤ Collection
utility.drop_collection("parliament_speeches")

# é‡æ–°æ„å»º
# python build_index.py
```

---

### ğŸ“ å­¦ä¹ èµ„æº

- **Milvus å®˜æ–¹æ–‡æ¡£**: https://milvus.io/docs
- **Milvus Lite ä»‹ç»**: https://milvus.io/docs/milvus_lite.md
- **å‘é‡æ•°æ®åº“åŸç†**: https://zilliz.com/learn/what-is-vector-database

---

## ğŸ“ æ€»ç»“

### âœ… æ¨èé…ç½®ï¼ˆå¼€å‘/ä¸ªäººä½¿ç”¨ï¼‰

```bash
# .env
MILVUS_MODE=lite
MILVUS_LITE_PATH=./milvus_data/milvus_lite.db
```

**ä¼˜ç‚¹**:
- æ— éœ€ Docker
- å®‰è£…ç®€å•
- å¯åŠ¨å¿«é€Ÿ
- å®Œå…¨æ»¡è¶³é¡¹ç›®éœ€æ±‚

### ğŸ¯ å…³é”®æ¦‚å¿µå›é¡¾

1. **Milvus** = å‘é‡æ•°æ®åº“ï¼ˆä¸“é—¨å­˜å‚¨å’Œæ£€ç´¢å‘é‡ï¼‰
2. **Collection** = è¡¨æ ¼ï¼ˆå­˜å‚¨å‘é‡å’Œå…ƒæ•°æ®çš„å®¹å™¨ï¼‰
3. **Milvus Lite** = è½»é‡çº§ç‰ˆæœ¬ï¼ˆæ— éœ€ Dockerï¼‰
4. **å‘é‡** = æ–‡æœ¬çš„æ•°å­¦è¡¨ç¤ºï¼ˆ1536ç»´æ•°ç»„ï¼‰

### ğŸš€ å¿«é€Ÿå¼€å§‹å‘½ä»¤

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. è¿è¡Œæ£€æŸ¥
python check_env.py

# 3. æ„å»ºç´¢å¼•
python build_index.py

# 4. å¯åŠ¨ç³»ç»Ÿ
python main.py
```

---

**ç°åœ¨æ‚¨å®Œå…¨ä¸éœ€è¦ Docker äº†ï¼** ğŸ‰
