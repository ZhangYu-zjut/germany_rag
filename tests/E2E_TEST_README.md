# 端到端真实环境测试指南

## 📋 测试概述

本测试脚本 `test_end_to_end_real.py` 用于验证完整系统流程：

1. **数据加载**：加载2018-2020年的真实德国议会演讲数据
2. **索引构建**：文本分块 → Embedding → 存储到Milvus
3. **工作流测试**：运行完整的问题回答流程
4. **质量验证**：检查输出质量和召回效果

## 🚀 运行步骤

### 1. 前置条件检查

#### 检查Milvus服务
```bash
# 检查Milvus是否运行
docker ps | grep milvus

# 如果未运行，启动Milvus
docker start milvus
# 或创建新容器
docker run -d --name milvus -p 19530:19530 milvusdb/milvus:latest
```

#### 检查环境变量配置
确保 `.env` 文件中配置了：
- `GEMINI_API_KEY`: Gemini API密钥（用于LLM和Embedding）
- `MILVUS_HOST`: Milvus主机地址（默认：localhost）
- `MILVUS_PORT`: Milvus端口（默认：19530）
- `MILVUS_COLLECTION_NAME`: Collection名称（默认：parliament_speeches）

### 2. 运行测试

```bash
cd /Users/zhangyu/project/germany_latest/tj_germany
python tests/test_end_to_end_real.py
```

### 3. 测试流程

#### 步骤1: 构建索引（约10-30分钟）
- 加载2018-2020年数据（`pp_2018.json`, `pp_2019.json`, `pp_2020.json`）
- 文本分块（chunk_size=1000, chunk_overlap=200）
- 生成Embedding向量（使用Gemini Embedding API）
- 存储到Milvus向量数据库

**注意**：
- 如果Collection已存在，会自动删除并重建
- Embedding过程可能需要较长时间，请耐心等待

#### 步骤2: 工作流测试
测试以下5个问题：

1. **简单问题**：
   - "2019年德国议会讨论了哪些主要议题？"
   - "2020年绿党在气候保护方面的主要观点是什么？"

2. **复杂问题 - 变化类**：
   - "在2018-2020年期间，CDU/CSU在难民政策上的立场有何变化？"

3. **复杂问题 - 对比类**：
   - "对比CDU/CSU、SPD和绿党在2019年数字化政策上的立场差异"

4. **复杂问题 - 总结类**：
   - "请总结2018-2020年期间，德国议会在气候保护方面的主要讨论"

## 📊 预期输出

### 索引构建阶段
```
📚 步骤1: 构建索引 - 加载2018-2020年数据
================================================================================
[1.1] 加载数据...
✅ 数据加载完成:
   - 演讲记录: XXXX 条
   - 年份分布: ['2018', '2019', '2020']
   - 发言人数: XXX

[1.2] 文本分块...
✅ 分块完成: XXXX 个文本块

[1.3] 元数据丰富...
✅ 元数据丰富完成

[1.4] 生成Embedding...
⏳ 开始批量Embedding（这可能需要几分钟）...
✅ Embedding完成:
   - 向量数量: XXXX
   - 向量维度: 1536

[1.5] 存储到Milvus...
⏳ 插入数据到Milvus...
⏳ 创建索引...
⏳ 加载Collection到内存...
✅ 索引构建完成:
   - Collection名称: parliament_speeches
   - 向量数量: XXXX
```

### 工作流测试阶段
```
🚀 步骤2: 运行完整工作流测试
================================================================================
[2.1] 初始化工作流...
✅ 工作流初始化成功

测试问题 1/5
================================================================================
问题: 2019年德国议会讨论了哪些主要议题？

开始处理...
✅ 处理成功:
   意图: simple
   问题类型: 事实查询
   答案长度: XXXX 字符

答案预览:
--------------------------------------------------------------------------------
[答案内容预览...]
--------------------------------------------------------------------------------
```

## 🔍 验证要点

### 1. 索引构建验证
- ✅ 数据加载成功（2018-2020年）
- ✅ 文本分块正常（chunks数量合理）
- ✅ Embedding生成成功（向量维度正确）
- ✅ Milvus存储成功（向量数量匹配）

### 2. 工作流验证
- ✅ 简单问题能正确识别意图（simple）
- ✅ 复杂问题能正确识别意图（complex）
- ✅ 问题分类正确（变化类/对比类/总结类）
- ✅ 能检索到相关材料
- ✅ 答案格式正确（德文输出，包含引用）

### 3. 输出质量验证
- ✅ 答案内容相关（与问题匹配）
- ✅ 引用格式正确（Redner, Partei, Datum）
- ✅ 答案结构完整（Zusammenfassung/Wichtige Aussagen/Belege/Quellen）

## ⚠️ 常见问题

### 1. Milvus连接失败
```
❌ Milvus连接失败: Connection refused
```
**解决方案**：
- 检查Milvus服务是否运行：`docker ps | grep milvus`
- 检查端口配置：确保19530端口未被占用
- 检查防火墙设置

### 2. Gemini API错误
```
❌ Gemini API连接失败: API key not found
```
**解决方案**：
- 检查 `.env` 文件中是否配置了 `GEMINI_API_KEY`
- 检查API密钥是否有效
- 检查网络连接

### 3. 数据文件不存在
```
❌ 未加载到任何数据，请检查数据文件是否存在
```
**解决方案**：
- 检查 `data/pp_json_49-21/` 目录下是否有 `pp_2018.json`, `pp_2019.json`, `pp_2020.json`
- 检查文件权限

### 4. Embedding超时
```
⏳ Embedding过程很慢...
```
**解决方案**：
- 这是正常现象，Gemini Embedding API需要时间
- 可以减少测试数据量（修改 `build_index_for_years` 中的年份列表）
- 检查网络连接速度

## 📝 测试结果解读

### 成功标志
- 所有5个测试问题都返回 `✅ PASS`
- 答案长度 > 100字符（说明有实际内容）
- 答案中包含德文引用格式

### 失败处理
- 查看错误日志，定位问题节点
- 检查Milvus数据是否成功存储
- 检查LLM API调用是否正常
- 检查问题是否符合数据范围（2018-2020年）

## 🎯 下一步

测试通过后，可以：
1. 扩展测试用例（更多年份、更多问题类型）
2. 优化Prompt（根据输出质量）
3. 性能调优（检索参数、分块大小等）
4. 部署到生产环境

## 📞 支持

如遇问题，请查看：
- `logs/app_*.log`: 应用日志
- `logs/error_*.log`: 错误日志
- `document/开发文档.md`: 开发文档

