# Quellenæºæ–‡æ¡£æå–æ–¹æ¡ˆåˆ†æ

**åˆ†ææ—¶é—´**: 2025-11-11
**åˆ†æç›®æ ‡**: è¯„ä¼°ä»ç°æœ‰logæå–å®Œæ•´å¼•ç”¨æ–‡æ¡£çš„å¯è¡Œæ€§

---

## ä¸€ã€Logæ–‡ä»¶å†…å®¹æ£€æŸ¥ç»“æœ

### âœ… Logä¸­åŒ…å«çš„ä¿¡æ¯

1. **Quellenå¼•ç”¨åˆ—è¡¨**:
```
**Quellen**
*   Barbara Woltmann (CDU/CSU), 2015-11-11
*   Andrea Lindholz (CDU/CSU), 2016-02-25
*   ...
```

2. **é—®é¢˜æå–çš„å‚æ•°**:
```json
{
  "time_range": {
    "start_year": "2015",
    "end_year": "2017",
    "specific_years": ["2015", "2016", "2017"]
  },
  "parties": ["CDU/CSU", "GrÃ¼ne/BÃ¼ndnis 90"],
  "topics": ["ç§»æ°‘èåˆ", "ç§»æ°‘èåˆæ”¿ç­–"],
  "keywords": ["å¯¹æ¯”", "ä¸»å¼ "]
}
```

3. **æ£€ç´¢ç»Ÿè®¡ä¿¡æ¯**:
- æ£€ç´¢åˆ°æ–‡æ¡£æ•°: 50
- å¹´ä»½åˆ†å¸ƒ: {'2015': 5, '2016': 5, ...}
- æ£€ç´¢æ–¹æ³•: multi_year_stratified
- æœ€é«˜ç›¸ä¼¼åº¦: 0.6424

### âŒ Logä¸­ç¼ºå¤±çš„ä¿¡æ¯

1. **âŒ å®Œæ•´çš„chunkæ–‡æœ¬**: Logä¸­æ²¡æœ‰è®°å½•æ£€ç´¢åˆ°çš„æ–‡æ¡£åŸæ–‡
2. **âŒ Chunk ID**: æ— æ³•ç›´æ¥é€šè¿‡IDå®šä½åŸæ–‡
3. **âŒ Metadataè¯¦æƒ…**: åªæœ‰ç»Ÿè®¡ä¿¡æ¯,æ²¡æœ‰æ¯ä¸ªchunkçš„å®Œæ•´metadata

---

## äºŒã€æ–¹æ¡ˆä¸€å¯è¡Œæ€§è¯„ä¼°

### æ–¹æ¡ˆä¸€A: ä»Log + Pineconeé‡æ„

**ç»“è®º**: âš ï¸ **éƒ¨åˆ†å¯è¡Œ,ä½†æœ‰å±€é™**

#### ä»»åŠ¡ä¸€: æå–å·²å¼•ç”¨çš„QuellenåŸæ–‡

**å¯è¡Œæ€§**: âœ… **å¯è¡Œ**

**å®ç°è·¯å¾„**:
```
Logä¸­çš„Quellen
  "Barbara Woltmann (CDU/CSU), 2015-11-11"
        â†“
  è§£æ: speaker="Barbara Woltmann", party="CDU/CSU", date="2015-11-11"
        â†“
  PineconeæŸ¥è¯¢: filter={
      "speaker": "Barbara Woltmann",
      "year": "2015", "month": "11", "day": "11"
  }
        â†“
  è·å–å®Œæ•´åŸæ–‡
```

**å±€é™æ€§**:
1. **Pinecone metadataå­—æ®µé—®é¢˜**:
   - éœ€è¦ç¡®è®¤metadataä¸­æœ‰`speaker`å­—æ®µ(å½“å‰å¯èƒ½åªæœ‰`group`)
   - å¦‚æœæ²¡æœ‰`speaker`å­—æ®µ,åªèƒ½é€šè¿‡`year`+`month`+`day`+`group`è¿‡æ»¤
   - å¯èƒ½åŒ¹é…åˆ°å¤šæ¡ç»“æœ(åŒä¸€å¤©åŒä¸€å…šæ´¾æœ‰å¤šäººå‘è¨€)

2. **å‘è¨€äººå§“ååŒ¹é…é—®é¢˜**:
   - Logä¸­: "Barbara Woltmann"
   - Pineconeä¸­å¯èƒ½æ˜¯: "Woltmann, Barbara" æˆ–å…¶ä»–æ ¼å¼
   - éœ€è¦fuzzy matching

#### ä»»åŠ¡äºŒ: å®½æ³›æ£€ç´¢å…¨éƒ¨ç›¸å…³æ–‡æ¡£

**å¯è¡Œæ€§**: âœ… **å®Œå…¨å¯è¡Œ**

**å®ç°è·¯å¾„**:
```
ä»Logæå–parameters
  topics: ["ç§»æ°‘èåˆ", "ç§»æ°‘èåˆæ”¿ç­–"]
  years: ["2015", "2016", "2017"]
  parties: ["CDU/CSU", "GrÃ¼ne/BÃ¼ndnis 90"]
        â†“
  ç›´æ¥æŸ¥è¯¢Pinecone: filter={
      "year": {"$in": ["2015", "2016", "2017"]},
      "group": {"$in": ["CDU/CSU", "GrÃ¼ne/BÃ¼ndnis 90"]}
  }
  + embedding(topics) ç›¸ä¼¼åº¦æ£€ç´¢
        â†“
  è®¡ç®—ä¸»é¢˜è¯é¢‘æ¬¡å¹¶æ’åº
```

**ä¼˜ç‚¹**:
- ä¸ä¾èµ–Logä¸­çš„chunkæ•°æ®
- å¯ä»¥è·å–æ‰€æœ‰ç›¸å…³æ–‡æ¡£
- å®Œå…¨ç‹¬ç«‹äºRAGæµç¨‹

---

## ä¸‰ã€æ–¹æ¡ˆå¯¹æ¯”:Logæå– vs Metadata+ID

### æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | ä»»åŠ¡ä¸€å¯è¡Œæ€§ | ä»»åŠ¡äºŒå¯è¡Œæ€§ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------------|------------|------|------|
| **æ–¹æ¡ˆA: ä»Log+Pinecone** | âš ï¸ éƒ¨åˆ†å¯è¡Œ | âœ… å®Œå…¨å¯è¡Œ | å¯ç«‹å³å®æ–½,ä¸æ”¹åŠ¨ç°æœ‰æµç¨‹ | ä»»åŠ¡ä¸€ä¾èµ–metadataå­—æ®µåŒ¹é… |
| **æ–¹æ¡ˆB: Metadata+ID** | âœ… å®Œå…¨å¯è¡Œ | âœ… å®Œå…¨å¯è¡Œ | ç²¾ç¡®å®šä½,æ— æ­§ä¹‰ | éœ€è¦ä¿®æ”¹æ•°æ®pipelineå’Œæµ‹è¯•æµç¨‹ |
| **æ–¹æ¡ˆC: --full_referå‚æ•°** | âœ… å®Œå…¨å¯è¡Œ | âœ… å®Œå…¨å¯è¡Œ | æœ€ä¼˜è§£,æŒ‰éœ€ç”Ÿæˆ | éœ€è¦é‡æ–°è¿è¡Œæµ‹è¯• |

### æ–¹æ¡ˆAè¯¦ç»†è¯„ä¼° (ä»Log+Pinecone)

**ä»»åŠ¡ä¸€çš„æŒ‘æˆ˜**:
1. **Pinecone metadataç°çŠ¶**:
   - éœ€è¦ç¡®è®¤metadataæ˜¯å¦åŒ…å«`speaker`å­—æ®µ
   - å½“å‰å·²çŸ¥å­—æ®µ: `year`, `month`, `day`, `group`, `lp`, `session`, `file`
   - å¦‚æœæ²¡æœ‰`speaker`,éœ€è¦å…¶ä»–åŒ¹é…ç­–ç•¥

2. **Quellenæ ¼å¼é—®é¢˜**:
   ```
   Log: "Barbara Woltmann (CDU/CSU), 2015-11-11"
   å¯èƒ½çš„Metadata:
   - speaker: "Barbara Woltmann" âœ…
   - speaker: "Woltmann, Barbara" âš ï¸
   - æ²¡æœ‰speakerå­—æ®µ âŒ
   ```

3. **åŒ¹é…ç­–ç•¥**:
   ```python
   # ç­–ç•¥1: ç²¾ç¡®åŒ¹é… (å¦‚æœæœ‰speakerå­—æ®µ)
   filter = {"speaker": "Barbara Woltmann", "year": "2015", "month": "11", "day": "11"}

   # ç­–ç•¥2: æ¨¡ç³ŠåŒ¹é… (å¦‚æœspeakeræ ¼å¼ä¸åŒ)
   results = pinecone.query(filter={"year": "2015", "month": "11", "day": "11", "group": "CDU/CSU"})
   # ç„¶ååœ¨ç»“æœä¸­æœç´¢åŒ…å«"Woltmann"çš„text

   # ç­–ç•¥3: ä»…é€šè¿‡æ—¥æœŸ+æ”¿å…š (æœ€å®½æ³›,å¯èƒ½ä¸å‡†ç¡®)
   results = pinecone.query(filter={"year": "2015", "month": "11", "day": "11", "group": "CDU/CSU"})
   # è¿”å›è¯¥æ—¥æœŸè¯¥å…šæ´¾çš„æ‰€æœ‰å‘è¨€
   ```

---

## å››ã€æ¨èæ–¹æ¡ˆ

### ğŸ¥‡ æ–¹æ¡ˆC: --full_referå‚æ•° (æœ€æ¨è)

**åŸç†**: åœ¨æµ‹è¯•æµç¨‹ä¸­å¢åŠ å‚æ•°,ä¿å­˜å®Œæ•´çš„retrieval_resultså’Œæœ€ç»ˆç­”æ¡ˆåˆ°JSON

**å®ç°**:
```bash
# è¿è¡Œæµ‹è¯•æ—¶åŠ ä¸Šå‚æ•°
python test_langgraph_complete.py --full_refer

# ç”Ÿæˆæ–‡ä»¶
output/
  â”œâ”€â”€ full_results.json  # åŒ…å«æ‰€æœ‰retrieval_results
  â”œâ”€â”€ é—®é¢˜ä¸€1.md  # ä»JSONæå–QuellenåŸæ–‡
  â”œâ”€â”€ é—®é¢˜ä¸€2.md  # ä»Pineconeå®½æ³›æ£€ç´¢
  â””â”€â”€ ...
```

**ä¼˜ç‚¹**:
- âœ… æœ€å‡†ç¡®:ç›´æ¥ä¿å­˜æ£€ç´¢åˆ°çš„åŸæ–‡,æ— éœ€é‡æ–°æŸ¥è¯¢
- âœ… æœ€å®Œæ•´:åŒ…å«æ‰€æœ‰ä¸­é—´ç»“æœ(retrieval_results, reranked_results)
- âœ… å¯è¿½æº¯:å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥çš„å¤„ç†è¿‡ç¨‹
- âœ… é«˜æ•ˆ:ä¸€æ¬¡è¿è¡Œ,ç”Ÿæˆæ‰€æœ‰éœ€è¦çš„æ–‡æ¡£

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦é‡æ–°è¿è¡Œ7ä¸ªé—®é¢˜çš„æµ‹è¯•(~10-20åˆ†é’Ÿ)
- âš ï¸ JSONæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§(~10-50MB)

**å®æ–½æ­¥éª¤**:
1. ä¿®æ”¹`test_langgraph_complete.py`:
   - æ·»åŠ `--full_refer`å‚æ•°
   - ä¿å­˜å®Œæ•´çš„`retrieval_results`åˆ°JSON
   - ä¿å­˜`reranked_results`(ç”¨äºä»»åŠ¡ä¸€)

2. åˆ›å»º`generate_quellen_docs.py`:
   - è¯»å–JSONæ–‡ä»¶
   - ä»»åŠ¡ä¸€:ä»`reranked_results`æå–QuellenåŸæ–‡
   - ä»»åŠ¡äºŒ:ä»parametersç›´æ¥æŸ¥è¯¢Pinecone

3. è¿è¡Œå¹¶ç”ŸæˆMDæ–‡ä»¶

---

### ğŸ¥ˆ æ–¹æ¡ˆA: ä»Log+Pinecone (å¤‡é€‰)

**é€‚ç”¨åœºæ™¯**: ä¸æƒ³é‡æ–°è¿è¡Œæµ‹è¯•,åŸºäºç°æœ‰log

**ä»»åŠ¡ä¸€å®æ–½**:
```python
# 1. å…ˆæ£€æŸ¥Pinecone metadata
sample = pinecone.fetch(ids=["ä»»æ„ä¸€ä¸ªID"])
print(sample.metadata)  # æŸ¥çœ‹æ˜¯å¦æœ‰speakerå­—æ®µ

# 2. æ ¹æ®metadataæƒ…å†µé€‰æ‹©åŒ¹é…ç­–ç•¥
if "speaker" in metadata:
    # ç²¾ç¡®åŒ¹é…
    strategy = "exact"
else:
    # å®½æ³›åŒ¹é… + æ–‡æœ¬æœç´¢
    strategy = "fuzzy"

# 3. æå–Quellen
for quellen_line in log:
    speaker, party, date = parse_quellen(quellen_line)
    chunks = fetch_from_pinecone(speaker, party, date, strategy)
    write_to_md(chunks)
```

**å±€é™æ€§**:
- âš ï¸ ä»»åŠ¡ä¸€å¯èƒ½ä¸å¤Ÿç²¾ç¡®(å¦‚æœåŒ¹é…åˆ°å¤šæ¡ç»“æœ)
- âš ï¸ éœ€è¦å¤„ç†å§“åæ ¼å¼å·®å¼‚

**ä»»åŠ¡äºŒå®æ–½**:
```python
# å®Œå…¨å¯è¡Œ,æ— é—®é¢˜
for question in log:
    params = extract_parameters(question)
    results = broad_search_pinecone(
        topics=params["topics"],
        years=params["specific_years"],
        parties=params["parties"],
        top_k=1000
    )
    results = sort_by_topic_frequency(results, params["topics"])
    write_to_md(results)
```

---

## äº”ã€Metadata+IDæ–¹æ¡ˆ (é•¿æœŸä¼˜åŒ–)

### ä¸ºä»€ä¹ˆéœ€è¦åœ¨metadataä¸­æ·»åŠ chunk_id?

**é—®é¢˜**: å½“å‰Pineconeçš„metadataç¼ºå°‘chunkçº§åˆ«çš„å”¯ä¸€æ ‡è¯†

**è§£å†³æ–¹æ¡ˆ**: åœ¨æ•°æ®è¿ç§»æ—¶æ·»åŠ `text_id`æˆ–`chunk_id`

**å¥½å¤„**:
1. ç²¾ç¡®å®šä½:é€šè¿‡IDç›´æ¥è·å–åŸæ–‡,æ— éœ€åŒ¹é…
2. å»é‡:é¿å…é‡å¤å¼•ç”¨
3. å¼•ç”¨è¿½æº¯:å¯ä»¥è¿½æº¯åˆ°åŸå§‹JSONæ–‡ä»¶çš„å…·ä½“ä½ç½®

**å®æ–½**:
```python
# æ•°æ®è¿ç§»æ—¶æ·»åŠ 
chunk_metadata = {
    "text_id": f"{year}_{session}_{speaker_index}_{chunk_index}",
    "year": "2015",
    "month": "11",
    "day": "11",
    "speaker": "Barbara Woltmann",
    "group": "CDU/CSU",
    # ...å…¶ä»–å­—æ®µ
}
```

**å½±å“èŒƒå›´**:
- éœ€è¦é‡æ–°è¿ç§»æ•°æ®(2015-2024)
- éœ€è¦ä¿®æ”¹retrievalé€»è¾‘,ä¿å­˜chunk_id
- éœ€è¦ä¿®æ”¹Quellenç”Ÿæˆé€»è¾‘,è¾“å‡ºchunk_id

---

## å…­ã€å¾…ç¡®è®¤é—®é¢˜

### 1. Pinecone Metadataå­—æ®µ

**è¯·è¿è¡Œä»¥ä¸‹ä»£ç ç¡®è®¤**:
```python
from pinecone import Pinecone
import os

pc = Pinecone(api_key=os.getenv('PINECONE_VECTOR_DATABASE_API_KEY'))
index = pc.Index("german-bge")

# éšæœºè·å–ä¸€ä¸ªchunk
results = index.query(vector=[0]*1024, top_k=1, include_metadata=True)
print("Metadataå­—æ®µ:", results.matches[0].metadata.keys())
print("å®Œæ•´Metadata:", results.matches[0].metadata)
```

**å…³é”®ç¡®è®¤**:
- âœ… æ˜¯å¦æœ‰`speaker`å­—æ®µ?
- âœ… speakeræ ¼å¼æ˜¯ä»€ä¹ˆ? ("Barbara Woltmann" vs "Woltmann, Barbara")
- âœ… æ˜¯å¦æœ‰`text_id`æˆ–`chunk_id`å­—æ®µ?

### 2. ä»»åŠ¡äºŒçš„æ£€ç´¢èŒƒå›´

**é—®é¢˜**: "åŒ…å«æ‰€æœ‰ç›¸å…³çš„æ–‡æ¡£"æ˜¯æŒ‡å¤šå°‘?

**å»ºè®®**:
- æ¯ä¸ªé—®é¢˜é™åˆ¶top_k=1000-2000
- MDæ–‡ä»¶ä¸­æ ‡æ³¨"å…±æ£€ç´¢åˆ°XXXæ¡,æ˜¾ç¤ºå‰500æ¡"
- æä¾›å®Œæ•´JSONæ–‡ä»¶ä¾›è¿›ä¸€æ­¥åˆ†æ

### 3. ORé€»è¾‘ç¡®è®¤

**æˆ‘çš„ç†è§£**:
```sql
(year IN specific_years)
AND
(group IN parties)
AND
(text CONTAINS ANY(topics))
```

**è¯·ç¡®è®¤**:
- Topicsä¹‹é—´æ˜¯ORå…³ç³»? (åŒ…å«"ç§»æ°‘èåˆ" OR "ç§»æ°‘èåˆæ”¿ç­–")
- å¹´ä»½ä¹‹é—´æ˜¯ORå…³ç³»? (2015 OR 2016 OR 2017)
- æ”¿å…šä¹‹é—´æ˜¯ORå…³ç³»? (CDU/CSU OR ç»¿å…š)
- å¹´ä»½å’Œæ”¿å…šä¹‹é—´æ˜¯ANDå…³ç³»?

---

## ä¸ƒã€æ¨èå®æ–½é¡ºåº

### Phase 1: å¿«é€ŸéªŒè¯ (1å°æ—¶)

1. âœ… æ£€æŸ¥Pinecone metadataå­—æ®µ
2. âœ… ç¡®è®¤ä»»åŠ¡äºŒçš„ORé€»è¾‘
3. âœ… å†³å®šé‡‡ç”¨æ–¹æ¡ˆAè¿˜æ˜¯æ–¹æ¡ˆC

### Phase 2: å®æ–½æ–¹æ¡ˆC (4-6å°æ—¶)

1. ä¿®æ”¹`test_langgraph_complete.py`æ·»åŠ `--full_refer`
2. é‡æ–°è¿è¡Œæµ‹è¯•,ç”Ÿæˆå®Œæ•´JSON
3. åˆ›å»º`generate_quellen_docs.py`
4. ç”Ÿæˆ14ä¸ªMDæ–‡ä»¶(ä»»åŠ¡ä¸€7ä¸ª+ä»»åŠ¡äºŒ7ä¸ª)

### Phase 3: éªŒè¯å’Œä¼˜åŒ– (2å°æ—¶)

1. äººå·¥æ£€æŸ¥éƒ¨åˆ†MDæ–‡ä»¶å‡†ç¡®æ€§
2. è°ƒæ•´æ’åºå’Œè¿‡æ»¤é€»è¾‘
3. ç”Ÿæˆæœ€ç»ˆäº¤ä»˜æ–‡æ¡£

---

## å…«ã€æˆ‘çš„å»ºè®®

**æ¨è**: é‡‡ç”¨**æ–¹æ¡ˆC (--full_referå‚æ•°)**

**ç†ç”±**:
1. æœ€å‡†ç¡®:ç›´æ¥ä¿å­˜retrieval_results,æ— éœ€äºŒæ¬¡åŒ¹é…
2. æœ€å®Œæ•´:å¯ä»¥ç”Ÿæˆä»»åŠ¡ä¸€å’Œä»»åŠ¡äºŒæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯
3. å¯æ‰©å±•:æœªæ¥å¯ä»¥ç”¨äºå…¶ä»–åˆ†æ(å¦‚æ£€ç´¢è´¨é‡è¯„ä¼°)
4. ä»£ä»·å¯æ§:é‡æ–°è¿è¡Œæµ‹è¯•åªéœ€10-20åˆ†é’Ÿ(å·²ä¼˜åŒ–å)

**ä¸‹ä¸€æ­¥**:
1. è¯·ç¡®è®¤Pinecone metadataå­—æ®µ(è¿è¡Œä¸Šé¢çš„ä»£ç )
2. è¯·ç¡®è®¤ä»»åŠ¡äºŒçš„ORé€»è¾‘
3. æˆ‘å°†æ ¹æ®ä½ çš„ç¡®è®¤è®¾è®¡--full_referçš„å…·ä½“å®ç°æ–¹æ¡ˆ

---

**æ€»ç»“**: ä»ç°æœ‰Logæå–QuellenåŸæ–‡**éƒ¨åˆ†å¯è¡Œä½†æœ‰å±€é™**,å»ºè®®é‡‡ç”¨**--full_referå‚æ•°**æ–¹æ¡ˆ,ä¸€æ¬¡è¿è¡Œç”Ÿæˆæ‰€æœ‰éœ€è¦çš„æ–‡æ¡£,æœ€å‡†ç¡®ä¸”æœ€é«˜æ•ˆã€‚
