# Phase 1 进展报告 - Prompt工程

**日期**: 2025-11-01  
**阶段**: Phase 1 - Prompt工程（Day 2）  
**状态**: 核心Prompt已完成 ✅

---

## 📊 本次工作总结

### 1. 用户确认事项 ✅

| 确认项 | 用户反馈 | 实施方案 |
|-------|---------|---------|
| Prompt语言 | ✅ 同意 | 内部推理用中文，最终输出德文 |
| Q&A评估集 | ✅ 一周后提供 | 现在先开发，预留评估代码和方式 |
| API接口 | ✅ 需要，但不急 | 前期预留，完整代码评估后再实现 |
| 全量索引时机 | ✅ 同意 | Phase 3后切换，Phase 5前完成 |

**API规格说明**：
- API规格 = API接口的技术规范（接口类型、请求/响应格式、认证方式等）
- 前期先实现命令行版本
- 后期会提供完整的API设计建议（REST API + JSON格式 + API Key认证）

---

### 2. Prompt模板开发 ✅

#### 已完成的Prompt模板

| Prompt类型 | 文件位置 | 状态 | 说明 |
|-----------|---------|------|------|
| **意图判断** | `src/llm/prompts.py` | ✅ 完成 | 判断简单/复杂问题 |
| **问题分类** | `src/llm/prompts.py` | ✅ 完成 | 5类问题分类（变化/总结/对比/事实/趋势） |
| **参数提取** | `src/llm/prompts.py` | ✅ 完成 | 提取时间/党派/议员/主题 |
| **问题拆解** | `src/llm/prompts_enhanced.py` | ✅ 完成 | 3种拆解策略（变化/对比/总结类） |
| **子问题总结** | `src/llm/prompts_enhanced.py` | ✅ 完成 | 中文简洁回答 |
| **最终总结** | `src/llm/prompts_enhanced.py` | ✅ 完成 | 德文结构化输出 |
| **德文系统提示词** | `src/llm/prompts_enhanced.py` | ✅ 完成 | 产品文档要求的系统提示词 |

---

### 3. Prompt设计特点

#### 3.1 意图判断Prompt

**设计原则**：
- 明确区分简单/复杂问题的判断标准
- 提供具体示例
- 输出结构化信息（复杂度、时间维度、对象维度、分析类型）

**关键特征**：
```
简单问题：单一时间点 + 单一对象 + 事实查询
复杂问题：时间跨度 + 多个对象 + 需要分析
```

---

#### 3.2 参数提取Prompt

**设计原则**：
- JSON结构化输出
- 覆盖所有关键参数（时间/党派/议员/主题）
- 处理特殊情况（如"ALL_PARTIES"）
- 提供详细示例

**输出格式**：
```json
{
    "time_range": {"start_year": "2015", "end_year": "2018", ...},
    "parties": ["CDU/CSU"] 或 ["ALL_PARTIES"],
    "speakers": ["Merkel"] 或 null,
    "topics": ["难民政策", "Flüchtlingspolitik"],
    "keywords": ["变化", "立场"]
}
```

---

#### 3.3 问题拆解Prompt

**三种拆解策略**：

1. **变化类问题**：按年份拆解
   ```
   原问题: "2015-2018年CDU/CSU在难民政策上有何变化？"
   拆解为:
   1. 2015年CDU/CSU在难民政策上的立场是什么？
   2. 2016年CDU/CSU在难民政策上的立场是什么？
   3. 2017年CDU/CSU在难民政策上的立场是什么？
   4. 2018年CDU/CSU在难民政策上的立场是什么？
   ```

2. **对比类问题**：按党派拆解
   ```
   原问题: "请对比2015-2017年CDU/CSU与绿党的主张"
   拆解为:
   1. 2015-2017年CDU/CSU的主张是什么？
   2. 2015-2017年BÜNDNIS 90/DIE GRÜNEN的主张是什么？
   ```

3. **总结类问题**：按时间跨度决定是否拆解
   ```
   时间跨度 ≤ 2年：不拆解（返回"NO_DECOMPOSITION"）
   时间跨度 > 2年：按年份拆解
   ```

**防爆炸机制**：
- 最多生成20个子问题
- 时间跨度>5年时，只拆解关键年份或每2年一个

---

#### 3.4 德文最终输出Prompt

**关键要素**：

1. **德文系统提示词**（产品文档要求）
   ```
   【Rolle】Du bist Politikexperte...
   【Kernaufgabe】Erstelle strukturierte Antwort...
   【Kritische Vorgaben】NIEMALS auslassen: politische Terminologie...
   ```

2. **结构化输出格式**
   ```
   **[Jahreszahl]**
   - **Sprecherzuordnung**: [Name], [Partei]
   - **Kernaussage**: [Hauptaussage]
   - **Beweisstücke**: [Fakten/Zitate]
   - **Datenquelle**: [text_id]
   ```

3. **质量要求**
   - 保留所有政治术语
   - 必须引用text_id
   - 保持因果关系
   - 材料不足时明确说明

---

## 📂 文件清单

### 新增文件

| 文件 | 说明 | 行数 |
|------|------|------|
| `src/llm/prompts_enhanced.py` | 增强版Prompt模板（拆解、总结、德文输出） | ~300行 |
| `PHASE1_PROGRESS.md` | 本报告 | - |

### 更新文件

| 文件 | 更新内容 | 状态 |
|------|---------|------|
| `src/llm/prompts.py` | 更新意图判断、问题分类、参数提取Prompt | ✅ 已完成 |

---

## 🎯 下一步工作

### Day 3任务（明天）

#### 上午（3-4小时）

**任务1：整合Prompt模块**
- 将`prompts_enhanced.py`的内容整合到`prompts.py`
- 确保所有Agent节点能够调用这些Prompt
- 统一Prompt管理接口

**任务2：更新Agent节点**
- 更新`DecomposeNode`以使用新的拆解Prompt
- 更新`SummarizeNode`以支持德文输出
- 确保每个节点都能正确调用对应的Prompt

#### 下午（3-4小时）

**任务3：集成系统提示词到LLM客户端**
- 修改`GeminiLLMClient`添加system_prompt参数
- 在最终总结时使用德文系统提示词

**任务4：端到端测试**
- 测试简单问题流程
- 测试Prompt是否能正确work
- 调试和修复发现的问题

---

### Day 4任务（后天）

**全天：集成测试与调试**
- 测试完整工作流（Intent → Classify → Extract → Decompose → Retrieve → Summarize）
- 测试3个简单问题
- 调试Prompt和逻辑
- 优化Prompt表述

**预期输出**：
- ✅ 系统能够端到端运行
- ✅ 能够回答至少2-3个简单问题
- ✅ 输出格式基本符合德文要求

---

## 🔍 当前技术细节

### Prompt设计原则

1. **清晰性**
   - 明确的角色定义（"你是...专家"）
   - 清晰的任务描述
   - 详细的输出格式

2. **示例驱动**
   - 每个Prompt都包含示例
   - 示例覆盖典型场景
   - 示例展示期望输出格式

3. **约束明确**
   - 明确禁止的行为（"不要..."）
   - 明确必须的行为（"必须..."）
   - 边界条件处理（如"材料不足时..."）

4. **结构化输出**
   - JSON格式（参数提取）
   - 列表格式（问题拆解）
   - 德文结构化格式（最终输出）

---

### 语言策略

**内部处理**（中文）：
- 意图判断
- 问题分类
- 参数提取
- 问题拆解
- 子问题回答
- 中间层汇总

**最终输出**（德文）：
- 最终答案（使用德文系统提示词）
- 结构化引用格式
- 专业政治术语

**优点**：
- ✅ 中文Prompt更容易编写和调试
- ✅ LLM对中文理解更准确
- ✅ 最终输出符合用户需求（德文）

---

## ⚠️ 注意事项

### 1. Prompt可能需要迭代

**原因**：
- LLM的实际输出可能与预期不完全一致
- 可能存在未预见的边界情况
- 可能需要根据实际测试结果调整

**建议**：
- Day 3-4留出充足的测试调试时间
- 准备快速迭代Prompt
- 记录失败案例，针对性优化

---

### 2. JSON解析可能失败

**风险**：
- LLM可能不严格按JSON格式输出
- 可能包含额外的解释文字

**应对方案**：
- 在Prompt中强调"只输出JSON，不要包含任何解释"
- 在代码中增加JSON解析的容错处理
- 使用正则表达式提取JSON部分

---

### 3. 德文输出质量需要验证

**注意**：
- 德文语法正确性
- 政治术语准确性
- 引用格式规范性

**建议**：
- Day 4测试时重点检查德文输出
- 必要时调整德文Prompt
- 考虑请德语专家审查样例输出

---

## 📊 Phase 1进度

```
Day 2: Prompt模板开发
├─ 上午: 意图判断、参数提取Prompt      ✅ 完成
├─ 下午: 问题分类、问题拆解Prompt      ✅ 完成  
└─ 晚上: 总结Prompt、德文系统提示词    ✅ 完成

Day 3: Prompt整合与节点更新 (明天)
├─ 上午: 整合Prompt模块                 🔄 待开始
├─ 上午: 更新Agent节点                  🔄 待开始
├─ 下午: 集成系统提示词                 🔄 待开始
└─ 下午: 端到端测试                     🔄 待开始

Day 4: 测试调试与优化 (后天)
└─ 全天: 测试、调试、优化Prompt         🔄 待开始
```

**完成度**: Day 2任务 100% ✅

---

## 🎉 阶段性成果

### 已实现

1. ✅ **完整的Prompt体系**
   - 7大类Prompt模板
   - 覆盖完整CoA流程
   - 中德双语支持

2. ✅ **三种问题拆解策略**
   - 变化类（按年份）
   - 对比类（按党派）
   - 总结类（条件拆解）

3. ✅ **德文输出支持**
   - 产品文档要求的系统提示词
   - 结构化德文输出格式
   - 专业政治术语保留

4. ✅ **防爆炸机制**
   - 最多20个子问题
   - 智能时间跨度处理

---

## 📞 需要用户关注

### 1. 下一步工作预告

**Day 3-4（明后天）**：
- 整合Prompt到现有系统
- 更新所有Agent节点
- 端到端测试
- **预期**：系统能回答简单问题

**提醒**：如果Day 3-4测试中发现Prompt效果不理想，可能需要额外1-2天迭代优化。

---

### 2. 可选：提前提供测试问题

如果你有一些典型问题想测试，可以提前提供，我会在Day 3-4优先测试这些问题。

**建议格式**：
```
简单问题（2-3个）：
1. 2019年德国联邦议院讨论了哪些主要议题？
2. ...

复杂问题（2-3个）：
1. 在2015-2018年期间，不同党派在难民问题上的立场有何变化？
2. ...
```

---

### 3. Q&A评估集

**提醒**：一周后需要提供完整的20个Q&A对。

**建议**：
- 可以基于产品文档中的示例问题
- 每类问题（变化/总结/对比/事实/趋势）至少3-4个
- 参考答案可以是简要的要点，不需要完整德文

---

## 📚 附录：Prompt模板示例

### 示例1：意图判断输出

```
用户问题: "在2015年到2018年期间,不同党派在难民问题上的立场有何变化?"

复杂度: 复杂
理由: 涉及时间跨度（2015-2018）、多个党派、变化分析

时间维度: 时间跨度
对象维度: 多个对象
分析类型: 变化分析
```

### 示例2：参数提取输出

```json
{
    "time_range": {
        "start_year": "2015",
        "end_year": "2018",
        "specific_date": null,
        "time_expression": null
    },
    "parties": ["ALL_PARTIES"],
    "speakers": null,
    "topics": ["难民政策", "难民家庭团聚"],
    "keywords": ["变化", "立场"]
}
```

### 示例3：问题拆解输出

```
1. 2015年CDU/CSU在难民政策上的立场是什么？
2. 2015年SPD在难民政策上的立场是什么？
3. 2015年绿党在难民政策上的立场是什么？
4. 2016年CDU/CSU在难民政策上的立场是什么？
5. 2016年SPD在难民政策上的立场是什么？
...
```

---

**报告完成时间**: 2025-11-01  
**下次更新**: Day 3完成后  
**状态**: Phase 1 Day 2任务完成 ✅

