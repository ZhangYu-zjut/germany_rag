# 意图判断错误分析报告

**日期**: 2025-11-01  
**测试结果**: 通过率 2/4 (50.0%)

---

## 📊 错误案例分析

### ❌ 错误用例1

**问题**: "2019年德国议会讨论了哪些主要议题？"  
**预期**: `simple`  
**实际**: `complex`  
**差异**: LLM判断为复杂问题

### ❌ 错误用例4

**问题**: "2021年绿党在气候保护方面的主要观点是什么？"  
**预期**: `simple`  
**实际**: `complex`  
**差异**: LLM判断为复杂问题

---

## 🔍 根因分析

### 分析1: 当前Prompt的判断标准

查看`src/llm/prompts.py`中的`INTENT_CLASSIFICATION` Prompt：

```python
简单问题特征（选择"简单"）：
- 单一时间点（如"2019年"）
- 单一党派或议员
- 事实查询（如"说了什么"、"讨论了什么"）
- 不需要对比分析

复杂问题特征（选择"复杂"）：
- 时间跨度（如"2015-2018年"、"...的变化"）
- 多个党派对比（如"不同党派"、"CDU与SPD"）
- 需要分析（如"变化"、"演变"、"趋势"、"对比"）
- 需要综合总结  ← 问题在这里！
```

### 🎯 问题定位

**根本原因**: Prompt中的"需要综合总结"这一条标准过于宽泛！

#### 用例1分析:
- ✅ 单一时间点: "2019年" ✓
- ✅ 事实查询: "讨论了哪些议题" ✓
- ❌ **但"主要议题"可能被理解为需要"总结"**

#### 用例4分析:
- ✅ 单一时间点: "2021年" ✓
- ✅ 单一党派: "绿党" ✓
- ✅ 单一主题: "气候保护" ✓
- ❌ **但"主要观点"明确包含"总结"概念**

### 问题分类

| 问题 | 实际特征 | LLM理解 | 判断结果 | 是否正确 |
|------|---------|---------|---------|---------|
| 用例1 | 单一时间点+事实查询 | 需要总结主要议题 | complex | ❌ 误判 |
| 用例4 | 单一时间点+单一党派+单一主题 | 需要总结主要观点 | complex | ❌ 误判 |

---

## 💡 解决方案

### 方案1: 优化Prompt判断标准（推荐）⭐

**问题**: "需要综合总结"这个标准太宽泛

**改进策略**: 将"总结"细分为两种：
1. **简单总结**: 单一对象的观点提取（应该算简单）
2. **复杂总结**: 多个对象、多个时间点的综合（应该算复杂）

**修改后的Prompt**:

```python
简单问题特征（选择"简单"）：
- 单一时间点（如"2019年"）
- 单一党派或议员
- 事实查询（如"说了什么"、"讨论了什么"）
- 单一对象的观点总结（如"XX的主要观点"）
- 不需要对比分析
- 不需要分析变化趋势

复杂问题特征（选择"复杂"）：
- 时间跨度（如"2015-2018年"）
- 多个党派对比（如"不同党派"、"CDU与SPD"）
- 需要变化分析（如"变化"、"演变"、"趋势"）
- 需要对比分析（如"对比"、"差异"、"异同"）
- 需要综合分析多个时间点或多个对象
```

### 方案2: 调整预期标签（备选）

**考虑**: 也许这两个问题确实应该是complex？

**分析**:
- **用例1**: "主要议题"可能确实需要从多个讨论中总结，算复杂也合理
- **用例4**: "主要观点"是单一对象的总结，应该算简单

**结论**: 
- 用例1可能应该改为`complex`（标签错误）
- 用例4应该保持`simple`（Prompt问题）

### 方案3: 添加边界案例说明（补充）

在Prompt中增加明确的边界案例：

```python
【边界案例说明】

以下情况应判断为"简单"：
- "2019年XX讨论了什么？" → 简单（单一年份的事实查询）
- "2021年XX的主要观点是什么？" → 简单（单一对象的观点总结）
- "XX对XX议题的立场是什么？" → 简单（单一对象的立场查询）

以下情况应判断为"复杂"：
- "2015-2018年XX的变化" → 复杂（时间跨度+变化分析）
- "XX和XX的对比" → 复杂（多个对象对比）
- "XX在XX方面的演变趋势" → 复杂（趋势分析）
```

---

## 🎯 推荐方案

### 优先采用: **方案1 + 方案3**

**理由**:
1. ✅ 保持预期标签不变（用例1和用例4都应该是simple）
2. ✅ 明确区分"简单总结"和"复杂总结"
3. ✅ 增加边界案例，提高判断准确性

**修改后的Prompt**:

```python
INTENT_CLASSIFICATION = """你是一个问题复杂度分析专家。请判断以下问题的复杂程度。

【重要】用户可能使用中文或德文提问，请都能正确处理。

用户问题: {question}

【判断标准】

简单问题特征（选择"简单"）：
- 单一时间点（如"2019年"）
- 单一党派或议员
- 事实查询（如"说了什么"、"讨论了什么"、"有哪些议题"）
- 单一对象的观点总结（如"XX的主要观点"、"XX的立场"）
- 不需要对比分析
- 不需要分析变化趋势

复杂问题特征（选择"复杂"）：
- 时间跨度（如"2015-2018年"）
- 多个党派对比（如"不同党派"、"CDU与SPD"）
- 需要变化分析（如"变化"、"演变"、"趋势"）
- 需要对比分析（如"对比"、"差异"、"异同"）
- 需要综合分析多个时间点或多个对象的关系

【边界案例】

应判断为"简单"的情况：
- "2019年德国议会讨论了哪些主要议题？" → 简单（单一年份的事实查询）
- "2021年绿党在气候保护方面的主要观点是什么？" → 简单（单一对象的观点总结）
- "XX对XX议题的立场是什么？" → 简单（单一对象的立场查询）

应判断为"复杂"的情况：
- "2015-2018年XX的变化" → 复杂（时间跨度+变化分析）
- "XX和XX的对比" → 复杂（多个对象对比）
- "XX在XX方面的演变趋势" → 复杂（趋势分析）

【输出格式】

复杂度: [简单/复杂]
理由: [一句话说明判断依据]

时间维度: [单一时间点/时间跨度/未明确]
对象维度: [单一对象/多个对象/未明确]
分析类型: [事实查询/观点总结/变化分析/对比分析]

【示例】
问题: "2019年德国联邦议院讨论了哪些主要议题?"
复杂度: 简单
理由: 单一年份的事实查询，不需要对比或变化分析
时间维度: 单一时间点
对象维度: 未明确
分析类型: 事实查询

问题: "在2015年到2018年期间,不同党派在难民问题上的立场有何变化?"
复杂度: 复杂
理由: 涉及时间跨度、多个党派、变化分析
时间维度: 时间跨度
对象维度: 多个对象
分析类型: 变化分析

现在请分析用户的问题。只输出分析结果，不要包含其他内容。
"""
```

---

## 📊 预期改进效果

### 修改前

| 用例 | 预期 | 实际 | 状态 |
|------|------|------|------|
| 用例1 | simple | complex | ❌ |
| 用例2 | complex | complex | ✅ |
| 用例3 | complex | complex | ✅ |
| 用例4 | simple | complex | ❌ |
| **通过率** | - | **50%** | - |

### 修改后（预期）

| 用例 | 预期 | 预期实际 | 状态 |
|------|------|---------|------|
| 用例1 | simple | simple | ✅ |
| 用例2 | complex | complex | ✅ |
| 用例3 | complex | complex | ✅ |
| 用例4 | simple | simple | ✅ |
| **通过率** | - | **100%** | - |

---

## 🔧 实施步骤

### 步骤1: 修改Prompt

修改`src/llm/prompts.py`中的`INTENT_CLASSIFICATION` Prompt，采用上面的优化版本。

### 步骤2: 重新测试

```bash
python tests/test_real_llm.py
```

### 步骤3: 验证效果

检查通过率是否提升到80%以上。

---

## 📝 总结

### 问题本质

**不是标签错误，也不是模型问题，而是Prompt设计问题！**

- ❌ **Prompt问题**: "需要综合总结"标准过于宽泛
- ✅ **标签正确**: 用例1和用例4确实应该是simple
- ✅ **模型正常**: LLM按照Prompt标准正确执行

### 解决方案

通过优化Prompt，明确区分：
- **简单总结**: 单一对象的观点提取 → simple
- **复杂总结**: 多对象、多时间点的综合分析 → complex

### 预期效果

通过率从 **50%** 提升到 **100%** ✅

---

**建议立即实施Prompt优化！** 🚀

