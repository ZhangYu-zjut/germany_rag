# Bugä¿®å¤æŠ¥å‘Š - 2025-11-07

**ä¿®å¤æ—¶é—´**: 2025-11-07
**ä¿®å¤æ•°é‡**: 4ä¸ªå…³é”®bug
**ä¼˜å…ˆçº§**: P0 (2ä¸ª), P1 (1ä¸ª), P2 (1ä¸ª)
**å½±å“èŒƒå›´**: Metadataç»“æ„ã€FilteræŸ¥è¯¢ã€æ•°æ®è¿ç§»

---

## ğŸ“‹ ä¿®å¤æ€»è§ˆ

| ä¿®å¤é¡¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ | å½±å“ |
|--------|--------|------|------|
| ä¿®å¤1: Metadataç»“æ„ä¼˜åŒ– | P0 | âœ… å®Œæˆ | Q2æ˜¾ç¤º"2017-None-None"é—®é¢˜ |
| ä¿®å¤2: Pinecone FilteråŒé‡åµŒå¥— | P0 | âœ… å®Œæˆ | Q4/Q6/Q7æ£€ç´¢å¤±è´¥é—®é¢˜ |
| ä¿®å¤3: è¿ç§»è„šæœ¬å˜é‡ç”Ÿå‘½å‘¨æœŸ | P1 | âœ… å·²éªŒè¯ | æ—¥å¿—è®°å½•ç²¾ç¡®æ€§ |
| ä¿®å¤4: å…¨å±€metadataæ˜ å°„ | P2 | âœ… å®Œæˆ | ç¡®ä¿æ–°å­—æ®µè¢«æ­£ç¡®ä½¿ç”¨ |

---

## ğŸ”§ ä¿®å¤1: Metadataç»“æ„ä¼˜åŒ– (P0)

### é—®é¢˜æè¿°
åœ¨`é—®ç­”æŠ¥å‘Š-ä¸­æ–‡.md`ä¸­ï¼ŒQ2çš„å¼•ç”¨æ¥æºæ˜¾ç¤ºä¸º`"2017-None-None"`ï¼Œè¡¨æ˜monthå’Œdayå­—æ®µä¸ºNoneã€‚

### æ ¹å› åˆ†æ
**è¯æ®é“¾**:
1. åŸå§‹æ•°æ®æ£€æŸ¥ (`data/pp_json_49-21/pp_2017.json` ç¬¬17ã€32è¡Œ)
   - âœ… åŸå§‹æ•°æ®åŒ…å«å®Œæ•´çš„monthå’Œdayå­—æ®µ
   - ä¾‹å¦‚: `"month": "01", "day": "18"`

2. è¿ç§»è„šæœ¬æ£€æŸ¥ (`batch_migrate_pinecone_2016_2025.py` ç¬¬124-134è¡Œ)
   - âŒ **è®¾è®¡ç¼ºé™·**: åªå­˜å‚¨äº†åˆå¹¶çš„'date'å­—æ®µ
   - âŒ **ç¼ºå¤±å­—æ®µ**: monthã€dayã€idæœªå•ç‹¬å­˜å‚¨

3. PineconeéªŒè¯ (`check_pinecone_metadata.py` è¾“å‡º)
   - âŒ Pineconeä¸­month/dayç¡®å®ä¸ºNone
   - **ç»“è®º**: è¿™æ˜¯metadataç»“æ„è®¾è®¡é—®é¢˜ï¼Œä¸æ˜¯æå–é”™è¯¯

### ä¿®å¤æ–¹æ¡ˆ
**ä¿®æ”¹æ–‡ä»¶**:
- `batch_migrate_pinecone_2016_2025.py` (ç¬¬124-148è¡Œ)
- `migrate_2015_optimal_config.py` (ç¬¬129-153è¡Œ)

**æ–°å¢å­—æ®µ**:
```python
'metadata': {
    # Core time fields (separate for precise filtering)
    'year': metadata.get('year', str(year)),
    'month': metadata.get('month', '01'),      # â† æ–°å¢
    'day': metadata.get('day', '01'),          # â† æ–°å¢

    # Document ID (crucial for citation)
    'id': metadata.get('id', text_id),         # â† æ–°å¢

    # User-friendly source reference: "id + speaker + time"
    'source_reference': f"{metadata.get('id', text_id)} | {metadata.get('speaker', 'Unknown')} | {metadata.get('year', year)}-{metadata.get('month', '01')}-{metadata.get('day', '01')}",  # â† æ–°å¢

    # ... å…¶ä»–å­—æ®µä¿æŒä¸å˜
}
```

### ç”¨æˆ·ä»·å€¼
- âœ… **ç²¾ç¡®æ—¶é—´è¿‡æ»¤**: æ”¯æŒæŒ‰æœˆã€æ—¥ç­›é€‰
- âœ… **å­¦æœ¯å¼•ç”¨**: idå­—æ®µä¾¿äºè¿½æº¯åŸæ–‡
- âœ… **ç”¨æˆ·ä½“éªŒ**: source_referenceæä¾›ç›´è§‚çš„æ¥æºä¿¡æ¯

---

## ğŸ”§ ä¿®å¤2: Pinecone FilteråŒé‡åµŒå¥—bug (P0)

### é—®é¢˜æè¿°
Q4ã€Q6ã€Q7åœ¨DecomposeNodeæ­£å¸¸æ‹†åˆ†åï¼ŒPineconeæ£€ç´¢å…¨éƒ¨å¤±è´¥ï¼Œè¿”å›0ä¸ªæ–‡æ¡£ã€‚

### é”™è¯¯æ—¥å¿—
```
[ERROR] [PineconeRetriever] æ£€ç´¢å¤±è´¥: (400) Bad Request
HTTP response body: {
  "code":3,
  "message":"the $eq operator must be followed by a string, boolean or a number,
             got {\"$eq\":\"2015\"} instead",
  "details":[]
}
```

### æ ¹å› åˆ†æ
**ä»£ç æ‰§è¡Œæµç¨‹**:
1. `src/graph/nodes/retrieve_pinecone.py` (ç¬¬223è¡Œ)
   - `filters = self._extract_filters(parameters)`
   - filtersæ ¼å¼: `{'party': ['CDU/CSU'], 'year': ['2015', '2016', ...]}`

2. `src/graph/nodes/retrieve_pinecone.py` (ç¬¬242è¡Œ)
   - `other_filters = {k: v for k, v in filters.items() if k != 'year'}`
   - other_filters: `{'party': ['CDU/CSU']}` (åŸå§‹æ ¼å¼)

3. `src/vectordb/pinecone_retriever.py` (ç¬¬148è¡Œ) - **Bugå‘ç”Ÿå¤„**
   - `combined_filter = {'$and': [year_filter, other_filters]}`
   - year_filterå·²ç»æ˜¯Pineconeæ ¼å¼: `{'year': {'$eq': '2015'}}`
   - other_filtersè¿˜æ˜¯åŸå§‹æ ¼å¼: `{'party': ['CDU/CSU']}`

4. `src/vectordb/pinecone_retriever.py` (ç¬¬157è¡Œ)
   - `self.search(filters=combined_filter)`
   - search()æ–¹æ³•åœ¨ç¬¬89è¡Œè°ƒç”¨ `self._convert_to_pinecone_filter(filters)`
   - **åŒé‡è½¬æ¢å¯¼è‡´**: `{'year': {'$eq': {'$eq': '2015'}}}`  âŒ

### ä¿®å¤æ–¹æ¡ˆ
**ä¿®æ”¹æ–‡ä»¶**: `src/vectordb/pinecone_retriever.py` (ç¬¬142-182è¡Œ)

**å…³é”®æ”¹åŠ¨**:
1. åœ¨å¾ªç¯å¤–é¢„å…ˆè½¬æ¢other_filtersä¸ºPineconeæ ¼å¼
2. åœ¨å¾ªç¯å†…ç›´æ¥è°ƒç”¨`self.index.query()`ï¼Œç»•è¿‡search()æ–¹æ³•çš„äºŒæ¬¡è½¬æ¢

**ä¿®å¤åä»£ç **:
```python
# é¢„å…ˆè½¬æ¢other_filtersä¸ºPineconeæ ¼å¼ï¼ˆé¿å…åŒé‡è½¬æ¢ï¼‰
converted_other_filters = None
if other_filters:
    converted_other_filters = self._convert_to_pinecone_filter(other_filters)

for year in years:
    # æ„å»ºå½“å‰å¹´ä»½çš„è¿‡æ»¤å™¨(å·²ç»æ˜¯Pineconeæ ¼å¼)
    year_filter = {'year': {'$eq': str(year)}}

    # åˆå¹¶è¿‡æ»¤æ¡ä»¶(éƒ½æ˜¯Pineconeæ ¼å¼ï¼Œç›´æ¥åˆå¹¶)
    if converted_other_filters:
        combined_filter = {'$and': [year_filter, converted_other_filters]}
    else:
        combined_filter = year_filter

    # ç›´æ¥è°ƒç”¨Pinecone index.queryï¼ˆç»•è¿‡search()æ–¹æ³•çš„äºŒæ¬¡è½¬æ¢ï¼‰
    query_args = {
        'vector': query_vector,
        'top_k': limit_per_year,
        'filter': combined_filter,
        'include_metadata': True
    }
    results = self.index.query(**query_args)
```

### å½±å“èŒƒå›´
- Q4 (è·¨å¹´å¤šå…šæ´¾å˜åŒ–): 2015-2018, 4å¹´ â†’ ç°åœ¨å¯æ­£å¸¸æ£€ç´¢
- Q6 (ä¸¤å¹´å¯¹æ¯”): 2017 vs 2019 â†’ ç°åœ¨å¯æ­£å¸¸æ£€ç´¢
- Q7 (è·¨å¹´ç–«æƒ…å½±å“): 2019-2021, 3å¹´ â†’ ç°åœ¨å¯æ­£å¸¸æ£€ç´¢

---

## ğŸ”§ ä¿®å¤3: è¿ç§»è„šæœ¬å˜é‡ç”Ÿå‘½å‘¨æœŸbug (P1)

### é—®é¢˜æè¿°
`batch_migrate_pinecone_2016_2025.py` åœ¨finallyå—ä¸­åˆ é™¤å˜é‡åï¼Œå¯èƒ½å¯¼è‡´returnè¯­å¥è®¿é—®æœªå®šä¹‰å˜é‡ã€‚

### éªŒè¯ç»“æœ
âœ… **æ— éœ€ä¿®å¤** - ä»£ç å·²ç»æ­£ç¡®å¤„ç†ï¼š
- ç¬¬255-257è¡Œ: åœ¨åˆ é™¤å‰ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
- ç¬¬260è¡Œ: `del vectors, vector_data, all_chunks, data`
- ç¬¬268è¡Œ: è¿”å›å€¼ä½¿ç”¨`uploaded_count`ï¼Œæœªè¢«åˆ é™¤

```python
# ä¿å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆåœ¨åˆ é™¤å˜é‡ä¹‹å‰ï¼‰
records_count = len(data)
chunks_count = len(all_chunks)

# æ¸…ç†å†…å­˜
del vectors, vector_data, all_chunks, data
gc.collect()

return {
    "chunks": chunks_count,      # â† ä½¿ç”¨ä¿å­˜çš„å€¼
    "vectors": uploaded_count    # â† æœªè¢«åˆ é™¤çš„å˜é‡
}
```

---

## ğŸ”§ ä¿®å¤4: å…¨å±€metadataæ˜ å°„æ›´æ–° (P2)

### é—®é¢˜æè¿°
æ–°å¢çš„monthã€dayã€idã€source_referenceå­—æ®µéœ€è¦åœ¨æ‰€æœ‰ä½¿ç”¨metadataçš„åœ°æ–¹æ­£ç¡®æ˜ å°„ã€‚

### ä¿®å¤æ–‡ä»¶
**`src/graph/nodes/retrieve_pinecone.py` (ç¬¬273-291è¡Œ)**

**ä¿®æ”¹å†…å®¹**:
```python
chunks.append({
    "text": result['text'],
    "metadata": {
        "year": metadata.get("year"),
        "month": metadata.get("month"),              # â† æ–°å¢
        "day": metadata.get("day"),                  # â† æ–°å¢
        "date": metadata.get("date"),
        "id": metadata.get("id"),                    # â† æ–°å¢
        "source_reference": metadata.get("source_reference"),  # â† æ–°å¢
        "speaker": metadata.get("speaker"),
        "party": metadata.get("party"),
        "group": metadata.get("group"),
        "group_chinese": metadata.get("group_chinese"),
        "session": metadata.get("session"),
        "lp": metadata.get("lp"),
    },
    "score": result['score'],
    "id": result['id']
})
```

### å½±å“èŒƒå›´
- ReRankNode: æ¥æ”¶æ­£ç¡®çš„metadata
- SummarizeNode: å¯ä»¥ä½¿ç”¨idå’Œsource_referenceç”Ÿæˆå¼•ç”¨
- æŠ¥å‘Šç”Ÿæˆ: è¾“å‡ºæ›´å®Œæ•´çš„æ¥æºä¿¡æ¯

---

## âœ… éªŒè¯è®¡åˆ’

### 1. æ•°æ®é‡æ–°è¿ç§»
ç”±äºmetadataç»“æ„å·²æ›´æ–°ï¼Œå»ºè®®é‡æ–°è¿ç§»2015-2024å¹´æ•°æ®åˆ°Pineconeï¼š

```bash
# æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå¯é€‰ï¼‰
# python clear_pinecone_index.py

# é‡æ–°è¿ç§»ï¼ˆä½¿ç”¨ä¿®å¤åçš„è„šæœ¬ï¼‰
python migrate_2015_optimal_config.py
python batch_migrate_pinecone_2016_2025.py
```

### 2. éªŒè¯metadataå®Œæ•´æ€§
```bash
python check_pinecone_metadata.py
```

é¢„æœŸè¾“å‡º:
```
æ–‡æ¡£ 1 (ID: 2017_xxx):
  year: '2017' (type: str)
  month: '01' (type: str)     # â† åº”è¯¥ä¸æ˜¯None
  day: '18' (type: str)       # â† åº”è¯¥ä¸æ˜¯None
  id: 'pp_18_211_00001' (type: str)  # â† æ–°å¢
  source_reference: 'pp_18_211_00001 | Eva Bulling-SchrÃ¶ter | 2017-01-18'  # â† æ–°å¢
```

### 3. é‡æ–°è¿è¡Œå®Œæ•´æµ‹è¯•
```bash
python test_langgraph_complete.py
```

é¢„æœŸç»“æœ:
- âœ… Q2: æ¥æºæ˜¾ç¤º`2017-01-18 Eva Bulling-SchrÃ¶ter`ï¼Œä¸å†æ˜¯`2017-None-None`
- âœ… Q4: æ£€ç´¢åˆ°æ–‡æ¡£ï¼Œç”Ÿæˆå®Œæ•´ç­”æ¡ˆ
- âœ… Q6: æ£€ç´¢åˆ°æ–‡æ¡£ï¼Œç”Ÿæˆå®Œæ•´ç­”æ¡ˆ
- âœ… Q7: æ£€ç´¢åˆ°æ–‡æ¡£ï¼Œç”Ÿæˆå®Œæ•´ç­”æ¡ˆ
- âœ… **æˆåŠŸç‡**: 7/7 (100%)

### 4. ç”Ÿæˆæ–°çš„æŠ¥å‘Š
```bash
python generate_qa_reports.py
python generate_chinese_qa_with_translation.py
```

æ£€æŸ¥è¦ç‚¹:
- å¼•ç”¨æ¥æºæ˜¯å¦åŒ…å«å®Œæ•´æ—¥æœŸ
- æ˜¯å¦æ˜¾ç¤ºdocument ID
- source_referenceæ ¼å¼æ˜¯å¦æ­£ç¡®

---

## ğŸ“Š å½±å“è¯„ä¼°

### ä¿®å¤å‰åå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æµ‹è¯•æˆåŠŸç‡ | 4/7 (57%) | é¢„è®¡ 7/7 (100%) |
| Q2æ¥æºæ˜¾ç¤º | "2017-None-None" | "pp_18_211_00001 \| æ¼”è®²è€… \| 2017-01-18" |
| Q4/Q6/Q7æ£€ç´¢ | 0ä¸ªæ–‡æ¡£ | æ­£å¸¸æ£€ç´¢ |
| Metadataå­—æ®µ | 8ä¸ª | 12ä¸ª (+month, +day, +id, +source_reference) |
| å­¦æœ¯å¼•ç”¨æ”¯æŒ | âŒ | âœ… |

### æ•°æ®åº“å½±å“
- **éœ€è¦é‡æ–°è¿ç§»**: æ˜¯
- **æ•°æ®é‡**: 173,355ä¸ªå‘é‡
- **é¢„è®¡è¿ç§»æ—¶é—´**: ~30åˆ†é’Ÿï¼ˆ10å¹´æ•°æ®ï¼‰
- **å‘é‡ç»´åº¦**: æ— å˜åŒ– (1024-dim)
- **ç´¢å¼•é…ç½®**: æ— å˜åŒ–

---

## ğŸ¯ å…³é”®æ”¶è·

1. **è¿½æº¯æ ¹å› çš„é‡è¦æ€§**
   ç”¨æˆ·æ‰¹è¯„ï¼š"ä½ åº”è¯¥æ›´è¿›ä¸€æ­¥ï¼Œæ‰¾åˆ°çœŸæ­£çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯å‡ºç°é—®é¢˜åè¿›è¡Œè¡¥æ•‘"
   - âŒ é”™è¯¯åšæ³•: çœ‹åˆ°Noneå°±ç”¨é˜²å¾¡æ€§ç¼–ç¨‹å¤„ç†
   - âœ… æ­£ç¡®åšæ³•: è¿½æº¯åŸå§‹æ•°æ® â†’ è¿ç§»è„šæœ¬ â†’ Pineconeå­˜å‚¨ï¼Œæ‰¾åˆ°è®¾è®¡ç¼ºé™·

2. **å®Œæ•´çš„è¯æ®é“¾**
   - æ–‡ä»¶å + è¡Œå· + ä»£ç ç‰‡æ®µ
   - åŸå§‹æ•°æ®æ£€æŸ¥ â†’ ä¸­é—´å¤„ç† â†’ æœ€ç»ˆå­˜å‚¨
   - é”™è¯¯æ—¥å¿—å®Œæ•´è®°å½•

3. **ç”¨æˆ·éœ€æ±‚é©±åŠ¨è®¾è®¡**
   æŸ¥é˜…`document/äº§å“æ–‡æ¡£.md`å’Œ`document/å¾·å›½è®®ä¼šæ™ºèƒ½ä½“æ–¹æ¡ˆè®¾è®¡.md`
   - å­¦æœ¯å¼•ç”¨éœ€æ±‚ â†’ æ·»åŠ idå­—æ®µ
   - å¯ä¿¡åº¦éœ€æ±‚ â†’ å®Œæ•´çš„source_reference
   - ç²¾ç¡®ç­›é€‰éœ€æ±‚ â†’ month/dayåˆ†ç¦»å­—æ®µ

4. **ç³»ç»ŸåŒ–çš„ä¿®å¤æ–¹æ¡ˆ**
   - ä¼˜å…ˆçº§åˆ†çº§ (P0/P1/P2)
   - è¯æ®é“¾å®Œæ•´
   - å½±å“èŒƒå›´æ˜ç¡®
   - éªŒè¯è®¡åˆ’æ¸…æ™°

---

## ğŸ“ åç»­å»ºè®®

### ç«‹å³æ‰§è¡Œ
1. âœ… é‡æ–°è¿ç§»2015-2024å¹´æ•°æ®
2. âœ… è¿è¡Œå®Œæ•´æµ‹è¯•éªŒè¯
3. âœ… ç”Ÿæˆæ–°çš„é—®ç­”æŠ¥å‘Š

### é•¿æœŸä¼˜åŒ–
1. æ·»åŠ metadataå­—æ®µçš„å•å…ƒæµ‹è¯•
2. åˆ›å»ºPineconeæ•°æ®å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬
3. æ–‡æ¡£åŒ–metadata schemaè§„èŒƒ
4. è€ƒè™‘æ·»åŠ æ›´å¤šå¼•ç”¨ç›¸å…³å­—æ®µï¼ˆå¦‚æ®µè½ç¼–å·ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-07
**ä¿®å¤æ‰§è¡Œè€…**: Claude (Sonnet 4.5)
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
