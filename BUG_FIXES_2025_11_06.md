# Bug修复报告 - 2025-11-06

## 背景

在完成首次LangGraph完整测试后，发现所有7个问题均失败，暴露出两个关键bug。本次修复解决了这些核心问题。

---

## Bug 1: Summarize节点Prompt模板错误 ❌→✅

### 问题描述

**症状**:
```python
KeyError: 'Jahr 1'
```

所有复杂问题（Q1, Q4, Q5, Q6, Q7）在Summarize阶段失败。

**根本原因**:

`src/llm/prompts_summarize.py`中的德语模板使用了包含空格的占位符作为示例格式：

```python
# 错误的模板（第95-106行）
**Zeitliche Entwicklung**

 **{Jahr 1}**
  - {Partei 1}: [Position]
  - {Partei 2}: [Position]

 **{Jahr 2}**
  - {Partei 1}: [Position]
```

Python的`.format()`方法试图解析`{Jahr 1}`时报错，因为：
1. 占位符名称包含空格（非法）
2. 这些实际上是**示例格式说明**，不应该被format()处理

### 解决方案

移除所有花括号占位符，改为纯文本示例：

```python
# 修复后的模板
**Zeitliche Entwicklung**

• **Jahr 1** (z.B. 2015)
  - Partei 1: [Position]
  - Partei 2: [Position]

• **Jahr 2** (z.B. 2017)
  - Partei 1: [Position]
```

**修改文件**:
- `src/llm/prompts_summarize.py`
  - `CHANGE_ANALYSIS_SUMMARY` (第95-123行)
  - `COMPARISON_SUMMARY` (第152-189行)
  - `SUMMARY_TYPE_SUMMARY` (第217-245行)
  - `TREND_ANALYSIS_SUMMARY` (第274-310行)

**影响**:
- ✅ 复杂问题的Summarize节点现在可以正常工作
- ✅ 所有模板保持德语格式指导的可读性

---

## Bug 2: 简单问题检索失败 ❌→✅

### 问题描述

**症状**:
```json
{
  "chunks": [],
  "year_distribution": {},
  "top_similarity_score": 0.0
}
```

Q2和Q3返回0个文档，尽管参数提取正常。

### 子问题 2.1: ALL_PARTIES未处理

**问题**:

Q2参数提取为：
```python
{
  "parties": ["ALL_PARTIES"]
}
```

但`retrieve_pinecone.py`的`_extract_filters()`直接将`"ALL_PARTIES"`传给Pinecone：

```python
# 第331-333行（原代码）
parties = parameters.get("parties", [])
if parties:
    filters['party'] = parties[0] if len(parties) == 1 else parties
```

Pinecone中不存在`group="ALL_PARTIES"`的文档，导致检索为空。

**修复**:

跳过`ALL_PARTIES`（表示不限制党派）：

```python
# 修复后代码（第332-335行）
parties = parameters.get("parties", [])
if parties and parties != ["ALL_PARTIES"]:
    if "ALL_PARTIES" not in parties:
        filters['party'] = ...
```

**修改文件**: `src/graph/nodes/retrieve_pinecone.py` (第332-355行)

---

### 子问题 2.2: 党派名称不匹配

**问题**:

Q3参数提取为：
```python
{
  "parties": ["BÜNDNIS 90/DIE GRÜNEN"]
}
```

但Pinecone中实际存储的绿党名称是：
```python
"group": "Grüne/Bündnis 90"
```

**验证**（2015年样本数据）:
```
党派分布:
  CDU/CSU: 15
  Grüne/Bündnis 90: 14    # ← 注意：不是BÜNDNIS 90/DIE GRÜNEN
  SPD: 13
  DIE LINKE: 5
```

**修复1 - Prompt指导**:

更新`extract_enhanced.py`的Prompt，明确指定Pinecone存储格式：

```python
# 第137-144行
2. **党派**（请使用Pinecone存储的标准名称）
   - CDU/CSU
   - SPD
   - FDP
   - Grüne/Bündnis 90（不要用BÜNDNIS 90/DIE GRÜNEN）
   - DIE LINKE
   - AfD
```

**修复2 - Fallback映射**:

添加党派名称映射字典（防止LLM仍然提取错误名称）：

```python
# retrieve_pinecone.py 第293-306行
PARTY_NAME_MAPPING = {
    "BÜNDNIS 90/DIE GRÜNEN": "Grüne/Bündnis 90",
    "BÜNDNIS 90": "Grüne/Bündnis 90",
    "DIE GRÜNEN": "Grüne/Bündnis 90",
    "GRÜNE": "Grüne/Bündnis 90",
    "绿党": "Grüne/Bündnis 90",
    # 其他党派保持不变
    "CDU/CSU": "CDU/CSU",
    "SPD": "SPD",
    ...
}
```

应用映射：

```python
# 第350-355行
if "ALL_PARTIES" not in parties:
    normalized_parties = [
        self.PARTY_NAME_MAPPING.get(p, p) for p in parties
    ]
    filters['party'] = normalized_parties[0] if len(normalized_parties) == 1 else normalized_parties
    logger.debug(f"党派映射: {parties} -> {normalized_parties}")
```

**修改文件**:
- `src/graph/nodes/extract_enhanced.py` (第137-144行)
- `src/graph/nodes/retrieve_pinecone.py` (第293-355行)

**影响**:
- ✅ Q2现在可以检索所有党派（不限制party过滤器）
- ✅ Q3现在可以正确检索绿党数据（名称映射生效）

---

## 测试验证

### 修复前

```
7/7 问题运行完成，但全部失败：
- Q1, Q4, Q5, Q6, Q7: KeyError: 'Jahr 1' (Summarize失败)
- Q2, Q3: 检索为空（0个文档）
```

### 修复后（预期）

```
所有问题应该能够：
1. ✅ 参数提取成功（"2015年以来" → ['2015', ..., '2024']）
2. ✅ 检索到文档（多年份分层检索 50个，简单问题标准检索）
3. ✅ ReRank成功（从50→10个高质量文档）
4. ✅ Summarize成功（生成完整德语答案）
5. ✅ 输出thinking过程（extraction_thinking, retrieval_thinking）
```

### 测试命令

```bash
source venv/bin/activate
python test_langgraph_complete.py 2>&1 | tee langgraph_complete_test_fixed.log
```

**预计耗时**: 18-20分钟（基于前一次测试）

---

## 修改文件清单

| 文件 | 行数 | 修改内容 | 影响 |
|------|------|----------|------|
| `src/llm/prompts_summarize.py` | 95-123 | 移除`{Jahr 1}`等占位符 | CHANGE_ANALYSIS_SUMMARY |
| `src/llm/prompts_summarize.py` | 152-189 | 移除`{Partei 1}`等占位符 | COMPARISON_SUMMARY |
| `src/llm/prompts_summarize.py` | 217-245 | 移除`{Thema 1}`等占位符 | SUMMARY_TYPE_SUMMARY |
| `src/llm/prompts_summarize.py` | 274-310 | 移除`{Zeitraum}`等占位符 | TREND_ANALYSIS_SUMMARY |
| `src/graph/nodes/retrieve_pinecone.py` | 293-306 | 添加`PARTY_NAME_MAPPING` | 党派名称标准化 |
| `src/graph/nodes/retrieve_pinecone.py` | 332-355 | 处理`ALL_PARTIES`+应用映射 | 简单问题检索修复 |
| `src/graph/nodes/extract_enhanced.py` | 137-144 | 更新Prompt指定标准党派名 | 提前规避名称不匹配 |

---

## 关键洞察

### 1. 为什么之前没发现这些bug？

**Prompt模板bug**:
- 模板是新创建的（`prompts_summarize.py`）
- 单元测试没有覆盖format()调用
- 之前使用简化RAG（没有Summarize节点）

**党派名称bug**:
- 数据来源不同导致命名不一致
- 元数据enrichment阶段可能引入变体
- 缺乏党派名称规范化层

### 2. 如何避免类似bug？

1. **模板规范**:
   - 所有Prompt模板的花括号必须是有效Python变量名
   - 或使用`{{`转义
   - 添加模板validation测试

2. **元数据标准化**:
   - 建立党派名称canonical mapping
   - 在DataLoader阶段统一规范化
   - 添加元数据一致性测试

3. **测试覆盖**:
   - 增加端到端测试（覆盖Summarize）
   - 增加边界case测试（ALL_PARTIES, 特殊党派名）
   - 自动化回归测试

---

## 性能影响

修复后的性能预期：

- **无性能损失**: 党派名称映射是简单dict查找（O(1)）
- **无额外API调用**: ALL_PARTIES检查是本地逻辑
- **Prompt模板**: 移除占位符简化了模板，略微减少token

---

## 后续建议

### 立即修复（已完成）
- [x] 修复Summarize Prompt模板
- [x] 修复ALL_PARTIES处理
- [x] 添加党派名称映射

### 短期改进（1-2天）
- [ ] 添加党派名称规范化到DataLoader
- [ ] 增加模板validation单元测试
- [ ] 增加端到端测试用例

### 长期优化（1周）
- [ ] 建立完整的元数据标准规范文档
- [ ] 重构元数据enrichment流程
- [ ] 增加自动化回归测试CI

---

**修复时间**: 2025-11-06 23:56
**修复工程师**: Claude (Sonnet 4.5)
**测试状态**: 正在运行中... (预计00:15完成)
