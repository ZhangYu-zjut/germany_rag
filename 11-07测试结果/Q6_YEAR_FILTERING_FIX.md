# Q6å¹´ä»½è¿‡æ»¤Bugä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025-11-10 17:25
**é—®é¢˜**: Q6 "2019å¹´ä¸2017å¹´ç›¸æ¯”"çš„ç¦»æ•£å¹´ä»½å¯¹æ¯”é—®é¢˜é”™è¯¯æ£€ç´¢äº†2018å¹´æ•°æ®
**æ ¹æœ¬åŸå› **: Retrieveé˜¶æ®µ`_extract_filters()`æ–¹æ³•ä¸­æ¡ä»¶ä¼˜å…ˆçº§é”™è¯¯

---

## é—®é¢˜æè¿°

### æµ‹è¯•é—®é¢˜ (Q6)
```
2019å¹´ä¸2017å¹´ç›¸æ¯”ï¼Œè”é‚¦è®®ä¼šå…³äºéš¾æ°‘é£è¿”çš„è®¨è®ºæœ‰ä½•å˜åŒ–ï¼Ÿ
```

### é”™è¯¯ç°è±¡
- **é¢„æœŸè¡Œä¸º**: åªæ£€ç´¢2017å’Œ2019å¹´çš„æ•°æ®
- **å®é™…è¡Œä¸º**: æ£€ç´¢äº†2017ã€2018ã€2019ä¸‰å¹´çš„æ•°æ®
- **å¹´ä»½åˆ†å¸ƒ**: `{'2017': 5, '2018': 5, '2019': 5}` (é”™è¯¯)

---

## æ ¹æœ¬åŸå› åˆ†æ

### å®Œæ•´è¯æ®é“¾

```
Extracté˜¶æ®µ âœ… (æ­£ç¡®)
â”œâ”€ start_year: "2017"
â”œâ”€ end_year: "2019"
â””â”€ specific_years: ["2017", "2019"]

Decomposeé˜¶æ®µ âœ… (æ­£ç¡®)
â”œâ”€ å­é—®é¢˜1: "2017å¹´è”é‚¦è®®ä¼šå…³äºéš¾æ°‘é£è¿”çš„è®¨è®º"
â””â”€ å­é—®é¢˜2: "2019å¹´è”é‚¦è®®ä¼šå…³äºéš¾æ°‘é£è¿”çš„è®¨è®º"

Retrieveé˜¶æ®µ âŒ (é”™è¯¯)
â”œâ”€ _extract_filters()æ–¹æ³•æ£€æŸ¥`if start_year and end_year`åœ¨å‰
â”œâ”€ æ‰§è¡Œ: range(2017, 2020) â†’ ['2017', '2018', '2019']
â””â”€ `elif specific_years`åˆ†æ”¯æ°¸è¿œä¸ä¼šæ‰§è¡Œ
```

### Bugä½ç½®
**æ–‡ä»¶**: `src/graph/nodes/retrieve_pinecone.py`
**æ–¹æ³•**: `PineconeRetrieveNode._extract_filters()`
**è¡Œ**: 327-348 (ä¿®å¤å)

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å‰çš„é”™è¯¯ä»£ç  (Lines 335-345)
```python
# âŒ é”™è¯¯: start_year/end_yearæ¡ä»¶åœ¨å‰,ä¼˜å…ˆçº§è¿‡é«˜
if start_year and end_year:
    # èŒƒå›´æŸ¥è¯¢: å±•å¼€ä¸ºè¿ç»­å¹´ä»½åˆ—è¡¨
    try:
        year_list = [str(y) for y in range(int(start_year), int(end_year) + 1)]
        filters['year'] = year_list  # ç”Ÿæˆ['2017', '2018', '2019']
        logger.debug(f"[PineconeRetrieveNode] å¹´ä»½èŒƒå›´ {start_year}-{end_year} -> {year_list}")
    except:
        pass
elif specific_years:  # â† æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼ˆstart_yearå’Œend_yearåŒæ—¶å­˜åœ¨æ—¶ï¼‰
    filters['year'] = specific_years if isinstance(specific_years, list) else [specific_years]
```

### ä¿®å¤åçš„æ­£ç¡®ä»£ç  (Lines 335-348)
```python
# âœ… æ­£ç¡®: specific_yearsæ¡ä»¶åœ¨å‰,ä¼˜å…ˆçº§æœ€é«˜
# ğŸ”§ ä¿®å¤: ä¼˜å…ˆä½¿ç”¨specific_yearsï¼ˆç¦»æ•£å¹´ä»½ï¼‰ï¼Œé¿å…ç¦»æ•£å¯¹æ¯”è¢«è¯¯åˆ¤ä¸ºè¿ç»­èŒƒå›´
# ä¾‹å¦‚ "2019å¹´ä¸2017å¹´ç›¸æ¯”" åº”è¯¥åªæ£€ç´¢ ['2017', '2019']ï¼Œè€Œä¸æ˜¯ ['2017', '2018', '2019']
if specific_years:
    # å…·ä½“å¹´ä»½åˆ—è¡¨ (ä¼˜å…ˆçº§æœ€é«˜ï¼Œæ”¯æŒç¦»æ•£å¯¹æ¯”)
    filters['year'] = specific_years if isinstance(specific_years, list) else [specific_years]
    logger.debug(f"[PineconeRetrieveNode] ä½¿ç”¨specific_years: {filters['year']}")
elif start_year and end_year:
    # èŒƒå›´æŸ¥è¯¢: åªåœ¨æ²¡æœ‰specific_yearsæ—¶ä½¿ç”¨ï¼Œå±•å¼€ä¸ºè¿ç»­å¹´ä»½åˆ—è¡¨
    try:
        year_list = [str(y) for y in range(int(start_year), int(end_year) + 1)]
        filters['year'] = year_list
        logger.debug(f"[PineconeRetrieveNode] å¹´ä»½èŒƒå›´ {start_year}-{end_year} -> {year_list}")
    except:
        pass
```

---

## ä¿®å¤æ•ˆæœ

### é¢„æœŸè¡Œä¸º (ä¿®å¤å)
```python
# Q6: "2019å¹´ä¸2017å¹´ç›¸æ¯”"
Extractè¾“å‡º: {
    "specific_years": ["2017", "2019"],
    "start_year": "2017",
    "end_year": "2019"
}

Retrieveè¡Œä¸º:
âœ… ä¼˜å…ˆæ£€æŸ¥specific_years â†’ filters['year'] = ["2017", "2019"]
âœ… å¹´ä»½åˆ†å¸ƒ: {'2017': X, '2019': Y'}
âœ… ä¸åŒ…å«2018å¹´æ•°æ®
```

### é€‚ç”¨åœºæ™¯
1. **ç¦»æ•£å¹´ä»½å¯¹æ¯”**: "2019å¹´ä¸2017å¹´ç›¸æ¯”" â†’ åªæ£€ç´¢`['2017', '2019']`
2. **å¤šä¸ªç¦»æ•£å¹´ä»½**: "2015ã€2018ã€2020å¹´çš„æƒ…å†µ" â†’ åªæ£€ç´¢`['2015', '2018', '2020']`
3. **è¿ç»­å¹´ä»½èŒƒå›´**: "2015-2018å¹´" (æ— specific_years) â†’ æ£€ç´¢`['2015', '2016', '2017', '2018']`

---

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆLLMä¼šåŒæ—¶è¿”å›start_year/end_yearå’Œspecific_years?

å› ä¸ºExtracté˜¶æ®µçš„æ—¶é—´è¯­ä¹‰ç†è§£å¢å¼º:
```python
# src/graph/nodes/extract_enhanced.py
# å¯¹äº "2019å¹´ä¸2017å¹´ç›¸æ¯”"ï¼ŒLLMè¿”å›:
{
    "start_year": "2017",  # æ—¶é—´èŒƒå›´çš„ä¸‹ç•Œ
    "end_year": "2019",    # æ—¶é—´èŒƒå›´çš„ä¸Šç•Œ
    "specific_years": ["2017", "2019"]  # æ˜¾å¼æ ‡æ³¨çš„ç¦»æ•£å¹´ä»½
}
```

è¿™ç§è®¾è®¡æ˜¯ä¸ºäº†åŒæ—¶ä¿ç•™:
- **è¯­ä¹‰èŒƒå›´**: start_year/end_year (ç”¨äºå…œåº•é€»è¾‘)
- **ç²¾ç¡®å¹´ä»½**: specific_years (ç”¨äºç¦»æ•£å¯¹æ¯”)

ä½†Retrieveé˜¶æ®µå¿…é¡»**ä¼˜å…ˆä½¿ç”¨`specific_years`**,å¦åˆ™ä¼šè¯¯åˆ¤ä¸ºè¿ç»­èŒƒå›´ã€‚

---

## ä¿®å¤éªŒè¯

### éªŒè¯æ–¹æ³•
1. è¿è¡ŒQ6æµ‹è¯•: `python test_q6_only.py`
2. æ£€æŸ¥å¹´ä»½åˆ†å¸ƒ: åº”è¯¥åªåŒ…å«`{'2017': X, '2019': Y'}`ï¼Œä¸åŒ…å«2018
3. æ£€æŸ¥retrieval_method: åº”è¯¥æ˜¾ç¤ºä½¿ç”¨äº†`multi_year_stratified(years=2, per_year=5)`

### é¢„æœŸæ—¥å¿—è¾“å‡º
```
ğŸ” Retrieveé˜¶æ®µè¾“å‡º:
   æ•´ä½“å¹´ä»½åˆ†å¸ƒ: {'2017': 5, '2019': 5}

âœ… éªŒè¯ç»“æœ:
   âœ… æˆåŠŸ: åªæ£€ç´¢äº†{'2017', '2019'}çš„æ•°æ®
   å‘ç°çš„å¹´ä»½: {'2017', '2019'}
   ä¿®å¤ç”Ÿæ•ˆï¼
```

---

## å½±å“èŒƒå›´

### ä¿®å¤å½±å“çš„é—®é¢˜ç±»å‹
- âœ… Q6: ä¸¤å¹´ç¦»æ•£å¯¹æ¯” ("2019å¹´ä¸2017å¹´ç›¸æ¯”")
- âœ… å¤šå¹´ç¦»æ•£å¯¹æ¯” ("2015ã€2018ã€2020å¹´çš„å¯¹æ¯”")
- âœ… ä¸å½±å“è¿ç»­å¹´ä»½èŒƒå›´æŸ¥è¯¢ ("2015-2018å¹´")

### ä»£ç ä¿®æ”¹
- **ä¿®æ”¹æ–‡ä»¶**: `src/graph/nodes/retrieve_pinecone.py` (1ä¸ªæ–‡ä»¶)
- **ä¿®æ”¹æ–¹æ³•**: `_extract_filters()` (1ä¸ªæ–¹æ³•)
- **ä¿®æ”¹è¡Œæ•°**: 14è¡Œ (Lines 335-348)
- **å‘åå…¼å®¹**: âœ… æ˜¯ (ä¸å½±å“å…¶ä»–é—®é¢˜ç±»å‹)

---

## æ€»ç»“

### ä¿®å¤è¦ç‚¹
1. **é—®é¢˜æœ¬è´¨**: æ¡ä»¶ä¼˜å…ˆçº§é”™è¯¯ï¼Œrangeé€»è¾‘ä¼˜å…ˆçº§è¿‡é«˜
2. **ä¿®å¤ç­–ç•¥**: è°ƒæ•´if-elifé¡ºåºï¼Œ`specific_years`ä¼˜å…ˆäº`start_year/end_year`
3. **è®¾è®¡åŸåˆ™**: Retrieveé˜¶æ®µåº”å…·æœ‰é˜²å¾¡æ€§ï¼Œæ­£ç¡®å¤„ç†Extractçš„ä»»ä½•è¾“å‡ºç»„åˆ

### ç»éªŒæ•™è®­
1. **é˜²å¾¡æ€§ç¼–ç¨‹**: Retrieveä¸åº”å‡è®¾Extractåªè¿”å›ä¸€ç§å‚æ•°ç»„åˆ
2. **å‚æ•°ä¼˜å…ˆçº§**: æ˜¾å¼å‚æ•°(specific_years)ä¼˜å…ˆäºæ¨æ–­å‚æ•°(range)
3. **æµ‹è¯•è¦†ç›–**: éœ€è¦è¦†ç›–ç¦»æ•£å¹´ä»½å¯¹æ¯”è¿™ç§edge case

---

**ä¿®å¤äºº**: Claude
**å®¡æ ¸äºº**: å¾…å®¡æ ¸
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼Œå¾…æµ‹è¯•éªŒè¯
