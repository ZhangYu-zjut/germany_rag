# 兜底策略设计文档

**创建时间**: 2025-11-01  
**目的**: 处理异常输入、边界情况和特殊问题

---

## 🎯 设计目标

**核心原则**: 任何用户输入都应该得到合理、友好的响应

**设计理念**: 
1. **宽进严出**: 接受各种输入，但严格验证
2. **友好引导**: 不直接拒绝，而是引导用户
3. **清晰边界**: 明确系统能力范围
4. **降级处理**: 无法完美处理时，提供降级方案

---

## 📋 需要处理的特殊情况

### 1. 元问题（Meta Questions）

**示例**:
- "你会做什么？"
- "你能帮我什么？"
- "这个系统有什么功能？"
- "如何使用？"

**处理方式**: **系统功能说明**

**输出示例**:
```
您好！我是德国联邦议院演讲记录智能问答系统。

【我能做什么】
1. 回答关于德国联邦议院（1949-2025年）的问题
2. 分析党派立场、议员发言、政策变化
...

【提问建议】
✅ 好的问题示例：
- "2019年德国议会讨论了哪些主要议题？"
- "2015-2018年不同党派在难民政策上的立场有何变化？"
```

---

### 2. 完全不相关的问题

**示例**:
- "今天天气怎么样？"
- "推荐一本书"
- "帮我写一篇文章"
- "1+1等于几？"

**处理方式**: **礼貌拒绝 + 引导**

**输出示例**:
```
抱歉，您的问题似乎与德国联邦议院无关。

【我的专长领域】
我专门用于分析德国联邦议院演讲记录，只能回答与以下主题相关的问题：
- 德国联邦议院的演讲和辩论
- 德国政党的立场和政策
...

【建议】
如果您对德国议会有任何问题，欢迎提问。例如：
- "2019年德国议会讨论了哪些主要议题？"
```

---

### 3. 模糊不清的问题

**示例**:
- "他们怎么说？" ← 谁？何时？说什么？
- "这个政策怎么样？" ← 哪个政策？
- "当时的情况如何？" ← 何时？什么情况？

**处理方式**: **引导补充信息**

**缺少时间信息的引导**:
```
您的问题我大致理解了，但缺少时间信息，无法准确回答。

【您的问题】
"CDU/CSU对难民政策的立场是什么？"

【缺少的信息】
时间信息（年份或时间范围）

【建议补充】
1. 如果您关心某个具体年份，请指定年份
   - 例如："2019年"、"2020年"

2. 如果您关心一个时间段，请指定范围
   - 例如："2015-2018年"

✅ 改进后："2019年CDU/CSU对难民政策的立场是什么？"
```

**缺少主题信息的引导**:
```
【缺少的信息】
主题或议题信息

【建议补充】
1. 请明确您关心的政策领域或议题
   - 例如："难民政策"、"气候保护"、"数字化"

✅ 改进后："2019年CDU/CSU在难民政策上的立场是什么？"
```

---

### 4. 超出数据范围的问题

#### 4.1 未来时间

**示例**:
- "2030年德国议会对气候政策的立场？"
- "2026年会讨论什么？"

**处理方式**: **说明范围限制 + 建议替代**

**输出示例**:
```
抱歉，您询问的内容超出了本系统的数据范围。

【识别的时间】2030年

【系统数据范围】1949年至2025年

【问题】
您询问的时间（2030年）在未来，系统数据只到2025年。

【建议】
1. 如果您想了解最近的情况，可以询问：
   - "2025年德国议会关于气候政策的讨论？"
   - "2023-2025年气候政策的趋势？"

2. 如果您想了解趋势，可以询问：
   - "2020-2025年德国议会对气候政策的态度有何演变？"
```

#### 4.2 过去时间（1949年之前）

**示例**:
- "1945年德国议会的情况？"
- "二战期间德国议会...？"

**处理方式**: **历史说明 + 引导**

**输出示例**:
```
【识别的时间】1945年

【系统数据范围】1949年至2025年

【问题】
您询问的时间（1945年）在德意志联邦共和国成立（1949年）之前，系统没有相关数据。

【建议】
1. 德国联邦议院（Deutscher Bundestag）成立于1949年

2. 如果您想了解战后早期情况，可以询问：
   - "1949年德国联邦议院成立初期讨论了哪些议题？"
   - "1950年代德国议会的主要政党有哪些？"
```

---

### 5. 不在5类分类中的其他问题

**示例**:
- "德国议会中有哪些女性议员发挥了重要作用？" ← 不是变化/总结/对比/事实/趋势
- "哪些议员经常在气候问题上发言？" ← 开放性问题
- "CDU/CSU和SPD的合作历史如何？" ← 复杂历史问题

**处理方式**: **尝试理解 + 降级处理**

**策略**:
1. 将问题重新理解为可处理的形式
2. 设计合理的检索策略
3. 给出部分答案 + 说明限制

**示例处理**:
```
问题: "德国议会中有哪些女性议员发挥了重要作用？"

【系统理解】
这是一个开放性问题，无法穷举所有女性议员。

【处理策略】
- 检索近年来（2015-2025）频繁发言的女性议员
- 识别担任重要职位的女性议员
- 提供部分代表性示例

【回答】（德文）
Im Zeitraum 2015-2025 haben mehrere weibliche Abgeordnete wichtige Rollen 
im Bundestag gespielt. Beispiele umfassen:

1. Angela Merkel (CDU) - Bundeskanzlerin 2005-2021
2. Katrin Göring-Eckardt (GRÜNE) - Fraktionsvorsitzende
...

Hinweis: Dies ist eine Auswahl und nicht vollständig.
```

---

## 🔄 工作流集成

### 增强的Intent节点

```
用户问题
    ↓
【问题合法性检查】
    ↓
┌─────────────────────┬─────────────────────┐
│ 系统功能查询         │ 不相关/模糊/超范围    │ 德国议会相关
│                     │                     │
↓                     ↓                     ↓
返回功能说明          返回引导/拒绝信息      继续正常流程
(END)                (END)                (Intent → Classify → ...)
```

### 增强的Exception节点

```
【异常类型判断】
    ↓
┌────────────┬────────────┬────────────┬────────────┐
│ 无材料      │ 信息不足    │ 超出范围    │ 不相关      │
│            │            │            │            │
↓            ↓            ↓            ↓
返回"未找到"  引导补充信息  说明范围限制  礼貌拒绝
```

---

## 📝 实现细节

### 1. IntentNode增强

**原有功能**:
- 判断简单/复杂

**新增功能**:
- **问题合法性检查**（在意图判断之前）
- 检查问题类型（系统功能查询/德国议会相关/不相关/模糊）
- 检查信息完整性
- 检查数据范围

**代码结构**:
```python
class EnhancedIntentNode:
    def __call__(self, state: GraphState) -> GraphState:
        question = state["question"]
        
        # 第一步：问题合法性检查
        validation_result = self._validate_question(question)
        
        if validation_result["处理方式"] == "系统功能说明":
            return self._return_capabilities()
        
        if validation_result["处理方式"] == "拒绝回答":
            return self._return_rejection(validation_result)
        
        if validation_result["处理方式"] == "引导补充信息":
            return self._return_guidance(validation_result)
        
        # 第二步：正常意图判断
        if validation_result["处理方式"] == "正常处理":
            return self._normal_intent_classification(question)
```

---

### 2. ClassifyNode增强

**原有分类**:
- 变化类、总结类、对比类、事实查询、趋势分析

**新增分类**:
- **其他类**（无法归入5类但相关的问题）

**处理策略**:
- 其他类问题尝试直接检索
- 使用通用的总结策略
- 在答案中说明这是部分结果

---

### 3. ExtractNode增强

**原有功能**:
- 提取时间/党派/议员/主题

**新增功能**:
- **参数完整性检查**
- 如果关键参数缺失，标记需要引导
- 生成具体的补充建议

**代码结构**:
```python
class EnhancedExtractNode:
    def __call__(self, state: GraphState) -> GraphState:
        question = state["question"]
        
        # 提取参数
        parameters = self._extract_parameters(question)
        
        # 检查完整性
        completeness = self._check_completeness(parameters)
        
        if completeness["status"] == "严重缺失":
            # 生成引导消息
            guidance = self._generate_guidance(
                question, 
                completeness["missing"]
            )
            return update_state(
                state,
                error="信息不足",
                guidance_message=guidance,
                next_node="exception"
            )
        
        # 正常处理
        return update_state(state, parameters=parameters, ...)
```

---

### 4. ExceptionNode增强

**原有功能**:
- 处理"无材料"情况

**新增功能**:
- **异常类型分类**
  - NO_MATERIAL: 材料中未找到
  - INSUFFICIENT_INFO: 信息不足
  - OUT_OF_RANGE: 超出范围
  - IRRELEVANT: 不相关问题
  - LLM_ERROR: LLM调用失败
  - RETRIEVAL_ERROR: 检索失败
  - UNKNOWN: 未知错误

**代码结构**:
```python
class EnhancedExceptionNode:
    def __call__(self, state: GraphState) -> GraphState:
        error_type = state.get("error_type")
        error = state.get("error", "")
        
        if error_type == "系统功能查询":
            message = FallbackPrompts.SYSTEM_CAPABILITIES
        
        elif error_type == "不相关":
            message = FallbackPrompts.format_irrelevant_response(
                state["question"]
            )
        
        elif error_type == "信息不足":
            message = state.get("guidance_message")
        
        elif error_type == "超出范围":
            message = self._generate_out_of_range_message(state)
        
        elif error_type == "无材料":
            message = self._generate_no_material_message(state)
        
        else:
            message = f"处理过程中发生错误: {error}"
        
        return update_state(
            state,
            final_answer=message,
            current_node="exception"
        )
```

---

## 🧪 测试案例

### 测试集1：元问题

| 输入 | 预期输出 | 状态 |
|------|---------|------|
| "你会做什么？" | 系统功能说明 | ⏳ 待测试 |
| "你能帮我什么？" | 系统功能说明 | ⏳ 待测试 |
| "如何使用这个系统？" | 系统功能说明 | ⏳ 待测试 |

### 测试集2：不相关问题

| 输入 | 预期输出 | 状态 |
|------|---------|------|
| "今天天气怎么样？" | 礼貌拒绝 + 引导 | ⏳ 待测试 |
| "推荐一本书" | 礼貌拒绝 + 引导 | ⏳ 待测试 |
| "1+1等于几？" | 礼貌拒绝 + 引导 | ⏳ 待测试 |

### 测试集3：模糊问题

| 输入 | 预期输出 | 状态 |
|------|---------|------|
| "他们怎么说的？" | 引导补充：时间+人物+主题 | ⏳ 待测试 |
| "这个政策怎么样？" | 引导补充：哪个政策+时间 | ⏳ 待测试 |
| "CDU的立场？" | 引导补充：时间+具体议题 | ⏳ 待测试 |

### 测试集4：超出范围

| 输入 | 预期输出 | 状态 |
|------|---------|------|
| "2030年的气候政策？" | 未来时间说明 + 建议 | ⏳ 待测试 |
| "1945年的情况？" | 历史说明 + 建议 | ⏳ 待测试 |
| "2026年会讨论什么？" | 未来时间说明 + 建议 | ⏳ 待测试 |

### 测试集5：边界正常问题

| 输入 | 预期输出 | 状态 |
|------|---------|------|
| "1949年的议会讨论？" | 正常处理（边界年份） | ⏳ 待测试 |
| "2025年最新的讨论？" | 正常处理（边界年份） | ⏳ 待测试 |

---

## 📊 实施优先级

### 高优先级（Phase 1必须完成）

- [x] ✅ 编写兜底Prompt模板
- [ ] 🔄 增强IntentNode（问题合法性检查）
- [ ] 🔄 增强ExceptionNode（多类型异常处理）
- [ ] 🔄 测试元问题和不相关问题

### 中优先级（Phase 2完成）

- [ ] ⏳ 增强ExtractNode（参数完整性检查）
- [ ] ⏳ 增强ClassifyNode（新增"其他类"）
- [ ] ⏳ 测试模糊问题和超出范围问题

### 低优先级（Phase 3-4完成）

- [ ] ⏳ 优化引导消息的表述
- [ ] ⏳ 增加更多边界情况测试
- [ ] ⏳ 用户反馈迭代

---

## 🎯 预期效果

### 用户体验改善

**之前**:
```
用户："你会做什么？"
系统：[尝试当作德国议会问题处理，返回无意义结果或报错]
```

**之后**:
```
用户："你会做什么？"
系统：[友好的功能介绍 + 使用示例]
```

**之前**:
```
用户："他们怎么说的？"
系统：[尝试检索，找不到结果，返回"材料中未找到"]
```

**之后**:
```
用户："他们怎么说的？"
系统：[引导补充：请告诉我您想了解谁、在什么时候、关于什么主题的发言？]
```

---

## 💡 最佳实践

### 1. 友好而非冷漠

❌ **不好的拒绝**:
```
错误：该问题不在系统处理范围内。
```

✅ **好的拒绝**:
```
抱歉，您的问题似乎与德国联邦议院无关。

我专门用于分析德国联邦议院演讲记录...

【建议】
如果您对德国议会有任何问题，欢迎提问。例如：...
```

---

### 2. 引导而非拒绝

❌ **不好的处理**:
```
错误：问题信息不足，无法处理。
```

✅ **好的处理**:
```
您的问题我大致理解了，但缺少一些关键信息：

【缺少的信息】时间信息

【建议补充】
1. 请指定年份（如"2019年"）
2. 或指定时间范围（如"2015-2018年"）

✅ 改进后："[具体年份] CDU/CSU对难民政策的立场是什么？"
```

---

### 3. 清晰边界

✅ **明确能力范围**:
```
【系统数据范围】
- 时间：1949年至2025年
- 来源：德国联邦议院官方演讲记录
- 语言：中文提问，德文回答
```

✅ **明确不能做什么**:
```
【系统限制】
❌ 不能预测未来（如"2030年会如何？"）
❌ 不能回答德国议会之外的问题
❌ 不能编造没有材料支持的内容
```

---

## 📁 文件清单

| 文件 | 说明 | 状态 |
|------|------|------|
| `src/llm/prompts_fallback.py` | 兜底策略Prompt模板 | ✅ 已创建 |
| `FALLBACK_STRATEGY.md` | 本文档 | ✅ 已创建 |
| `src/graph/nodes/intent.py` | 需要更新（增加合法性检查） | ⏳ 待更新 |
| `src/graph/nodes/exception.py` | 需要更新（多类型异常） | ⏳ 待更新 |
| `src/graph/nodes/extract.py` | 需要更新（完整性检查） | ⏳ 待更新 |

---

## 🚀 下一步行动

### Day 3上午（明天）

1. **更新IntentNode**
   - 集成问题合法性检查
   - 处理元问题、不相关问题
   - 测试基本兜底功能

2. **更新ExceptionNode**
   - 支持多种异常类型
   - 集成所有引导消息模板
   - 测试异常处理流程

### Day 3下午（明天）

3. **集成测试**
   - 测试元问题："你会做什么？"
   - 测试不相关："今天天气怎么样？"
   - 测试模糊问题："他们怎么说？"
   - 测试超出范围："2030年...？"

4. **优化调整**
   - 根据测试结果优化Prompt
   - 优化引导消息表述
   - 确保用户体验友好

---

## 📝 附录：关键Prompt示例

### A. 问题合法性检查输出示例

```
问题: "你会做什么？"

问题类型: 系统功能查询
信息完整性: 完整
数据范围: 未指定
是否可处理: 是
建议处理方式: 系统功能说明
理由: 用户询问系统功能
```

```
问题: "今天天气怎么样？"

问题类型: 完全不相关
信息完整性: 完整
数据范围: 未指定
是否可处理: 否
建议处理方式: 拒绝回答
理由: 问题与德国议会无关
```

```
问题: "他们怎么说的？"

问题类型: 模糊不清
信息完整性: 严重缺失
数据范围: 未指定
是否可处理: 否
建议处理方式: 引导补充信息
理由: 缺少时间、人物、主题信息
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-01  
**状态**: 设计完成，待实施

