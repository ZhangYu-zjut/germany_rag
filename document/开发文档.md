# å¾·å›½è®®ä¼šæ™ºèƒ½é—®ç­”ç³»ç»Ÿ - å¼€å‘æ–‡æ¡£

**é¡¹ç›®**: å¾·å›½è”é‚¦è®®é™¢æ¼”è®²è®°å½•æ™ºèƒ½é—®ç­”RAGç³»ç»Ÿ  
**åˆ›å»ºæ—¥æœŸ**: 2025-11-01  
**æœ€åæ›´æ–°**: 2025-11-01

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
2. [æ ¸å¿ƒç­–ç•¥](#æ ¸å¿ƒç­–ç•¥)
3. [å…³é”®è®¾è®¡å†³ç­–](#å…³é”®è®¾è®¡å†³ç­–)
4. [APIè§„èŒƒ](#apiè§„èŒƒ)
5. [æµ‹è¯•æŒ‡å—](#æµ‹è¯•æŒ‡å—)
6. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)

---

## ç³»ç»Ÿæ¶æ„

### æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: LangGraph (Chain of Agents)
- **LLM**: Gemini 2.5 Pro
- **Embedding**: Gemini Embedding (1536ç»´)
- **å‘é‡æ•°æ®åº“**: Milvus (æœ¬åœ°/äº‘ç«¯)
- **è¯­è¨€**: Python 3.11+

### å·¥ä½œæµç¨‹

```
ç”¨æˆ·é—®é¢˜
    â†“
Intent Node (æ„å›¾åˆ¤æ–­ + åˆæ³•æ€§æ£€æŸ¥)
    â†“
Classify Node (é—®é¢˜åˆ†ç±»)
    â†“
Extract Node (å‚æ•°æå–)
    â†“
Decompose Node (é—®é¢˜æ‹†è§£) [å¦‚éœ€è¦]
    â†“
Retrieve Node (å‘é‡æ£€ç´¢)
    â†“
Summarize Node (æ€»ç»“ç”Ÿæˆ)
    â†“
æœ€ç»ˆç­”æ¡ˆ
```

---

## æ ¸å¿ƒç­–ç•¥

### 1. é—®é¢˜æ‹†è§£ç­–ç•¥ â­

**åˆ¶å®šæ—¥æœŸ**: 2025-11-01  
**é€‚ç”¨åœºæ™¯**: å˜åŒ–ç±»ã€æ€»ç»“ç±»ã€å¯¹æ¯”ç±»ã€è¶‹åŠ¿åˆ†æç±»é—®é¢˜

#### 1.1 å˜åŒ–ç±»é—®é¢˜ - æ™ºèƒ½æ—¶é—´æ‹†è§£

**æ ¸å¿ƒåŸåˆ™**: æ ¹æ®æ—¶é—´è·¨åº¦å†³å®šæ‹†è§£ç²’åº¦ï¼Œå¹³è¡¡åˆ†æç²¾åº¦ä¸ç³»ç»Ÿæˆæœ¬

| æ—¶é—´è·¨åº¦ | æ‹†è§£ç­–ç•¥ | ç¤ºä¾‹ | å­é—®é¢˜æ•°ï¼ˆå•å…šæ´¾ï¼‰ |
|---------|---------|------|------------------|
| **â‰¤5å¹´** | æŒ‰**æ¯å¹´**æ‹†è§£ | 2015-2018å¹´ â†’ 4å¹´ | 4ä¸ª |
| **6-10å¹´** | æŒ‰**2å¹´**æ‹†è§£ | 2010-2018å¹´ â†’ 5ä¸ªé‡‡æ ·ç‚¹ | 5ä¸ª |
| **>10å¹´** | **æ™ºèƒ½é‡‡æ ·**ï¼ˆçº¦5ä¸ªå…³é”®ç‚¹ï¼‰ | 2000-2020å¹´ â†’ 5ä¸ªé‡‡æ ·ç‚¹ | 5ä¸ª |

**è®¾è®¡åŸå› **:

1. **çŸ­æœŸï¼ˆâ‰¤5å¹´ï¼‰å¿…é¡»æŒ‰å¹´æ‹†è§£**
   - âœ… æ•æ‰å…³é”®è½¬æŠ˜ç‚¹ï¼ˆå¦‚æ”¿ç­–å˜åŒ–ã€é‡å¤§äº‹ä»¶ï¼‰
   - âœ… ç†è§£å˜åŒ–çš„æ¸è¿›æ€§æˆ–çªå˜æ€§
   - âœ… å‡†ç¡®æè¿°æ¼”å˜è½¨è¿¹
   - âŒ å¦‚æœåªæœ‰èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œä¼šæ¼æ‰ä¸­é—´çš„è½¬æŠ˜

2. **ä¸­æœŸï¼ˆ6-10å¹´ï¼‰æŒ‰2å¹´æ‹†è§£**
   - âœ… å¹³è¡¡ç²¾åº¦å’Œæˆæœ¬
   - âœ… ä»èƒ½æ•æ‰ä¸»è¦è¶‹åŠ¿
   - âœ… å­é—®é¢˜æ•°é‡å¯æ§

3. **é•¿æœŸï¼ˆ>10å¹´ï¼‰æ™ºèƒ½é‡‡æ ·**
   - âœ… é¿å…å­é—®é¢˜è¿‡å¤šï¼ˆå¦‚20å¹´Ã—2å…šæ´¾=40ä¸ªå­é—®é¢˜ï¼‰
   - âœ… æ§åˆ¶æ£€ç´¢æˆæœ¬ï¼ˆæ¯ä¸ªå­é—®é¢˜top_k=5ï¼Œ40ä¸ª=200 chunksï¼‰
   - âœ… å¯æ•æ‰é•¿æœŸè¶‹åŠ¿ï¼Œè™½ç„¶æŸå¤±éƒ¨åˆ†ç»†èŠ‚

**å®ç°ä½ç½®**: `src/graph/templates/decompose_templates.py` - `ChangeAnalysisTemplate`

**ä»£ç ç¤ºä¾‹**:
```python
span = end_year - start_year

if span <= 5:
    # çŸ­æœŸï¼šæŒ‰æ¯å¹´æ‹†è§£
    for year in range(start, end + 1):
        sub_questions.append(f"{year}å¹´{party}åœ¨{topic}ä¸Šçš„ç«‹åœºï¼Ÿ")
        
elif span <= 10:
    # ä¸­æœŸï¼šæŒ‰2å¹´æ‹†è§£
    for year in range(start, end + 1, 2):
        sub_questions.append(f"{year}å¹´{party}åœ¨{topic}ä¸Šçš„ç«‹åœºï¼Ÿ")
    
else:
    # é•¿æœŸï¼šæ™ºèƒ½é‡‡æ ·
    sample_years = [start, ..., end]  # åˆ†æˆçº¦5æ®µ
    for year in sample_years:
        sub_questions.append(f"{year}å¹´{party}åœ¨{topic}ä¸Šçš„ç«‹åœºï¼Ÿ")
```

**æµ‹è¯•ç”¨ä¾‹**:
```python
# æµ‹è¯•1: çŸ­æœŸï¼ˆ4å¹´ï¼‰
params = {
    'time_range': {'start_year': '2015', 'end_year': '2018'},
    'parties': ['CDU/CSU', 'SPD'],
    'topics': ['éš¾æ°‘æ”¿ç­–']
}
# é¢„æœŸ: 2å…šæ´¾ Ã— 4å¹´ + 1å¯¹æ¯” = 9ä¸ªå­é—®é¢˜

# æµ‹è¯•2: ä¸­æœŸï¼ˆ9å¹´ï¼‰
params = {
    'time_range': {'start_year': '2010', 'end_year': '2018'},
    'parties': ['CDU/CSU'],
    'topics': ['æ°”å€™æ”¿ç­–']
}
# é¢„æœŸ: 1å…šæ´¾ Ã— 5ä¸ªé‡‡æ ·ç‚¹ + 1å¯¹æ¯” = 6ä¸ªå­é—®é¢˜

# æµ‹è¯•3: é•¿æœŸï¼ˆ21å¹´ï¼‰
params = {
    'time_range': {'start_year': '2000', 'end_year': '2020'},
    'parties': ['CDU/CSU'],
    'topics': ['å¤–äº¤æ”¿ç­–']
}
# é¢„æœŸ: 1å…šæ´¾ Ã— 5ä¸ªé‡‡æ ·ç‚¹ + 1å¯¹æ¯” = 6ä¸ªå­é—®é¢˜
```

#### 1.2 æ€»ç»“ç±»é—®é¢˜æ‹†è§£

**ç­–ç•¥**:
- æŒ‰æ—¶é—´/è®®å‘˜/å…šæ´¾/ä¸»é¢˜æ‹†è§£
- å¦‚æœæ—¶é—´è·¨åº¦>2å¹´ï¼ŒæŒ‰å¹´ä»½æ‹†è§£
- å¦‚æœæœ‰å¤šä¸ªå¯¹è±¡ï¼ˆå…šæ´¾/è®®å‘˜ï¼‰ï¼Œä¸ºæ¯ä¸ªå¯¹è±¡ç”Ÿæˆç‹¬ç«‹é—®é¢˜

**å®ç°ä½ç½®**: `src/graph/templates/decompose_templates.py` - `SummaryTemplate`

#### 1.3 å¯¹æ¯”ç±»é—®é¢˜æ‹†è§£

**ç­–ç•¥**:
- ä¸ºæ¯ä¸ªå¯¹æ¯”å¯¹è±¡ç”Ÿæˆç‹¬ç«‹é—®é¢˜
- ç”Ÿæˆä¸€ä¸ªå¯¹æ¯”æ€»ç»“é—®é¢˜

**å®ç°ä½ç½®**: `src/graph/templates/decompose_templates.py` - `ComparisonTemplate`

#### 1.4 è¶‹åŠ¿åˆ†æé—®é¢˜æ‹†è§£

**ç­–ç•¥**:
- æŒ‰æ—¶é—´æ®µæ‹†è§£ï¼ˆä¸å˜åŒ–ç±»ç±»ä¼¼ï¼‰
- ç”Ÿæˆè¶‹åŠ¿æ€»ç»“é—®é¢˜

**å®ç°ä½ç½®**: `src/graph/templates/decompose_templates.py` - `TrendAnalysisTemplate`

---

### 2. åŒè¯­æ”¯æŒç­–ç•¥

**åˆ¶å®šæ—¥æœŸ**: 2025-11-01  
**æ”¯æŒè¯­è¨€**: ä¸­æ–‡ã€å¾·æ–‡

#### 2.1 è¯­è¨€æ£€æµ‹è§„åˆ™

1. ä¸­æ–‡å­—ç¬¦å æ¯” > 30% â†’ ä¸­æ–‡
2. åŒ…å«å¾·æ–‡ç‰¹æ®Šå­—ç¬¦(Ã¤, Ã¶, Ã¼, ÃŸ) â†’ å¾·æ–‡
3. åŒ…å«3ä¸ªä»¥ä¸Šå¾·æ–‡å…³é”®è¯ â†’ å¾·æ–‡
4. é»˜è®¤ â†’ ä¸­æ–‡

**å®ç°ä½ç½®**: `src/utils/language_detect.py`

#### 2.2 ç³»ç»Ÿå“åº”ç­–ç•¥

- æ£€æµ‹åˆ°ä¸­æ–‡ â†’ è¿”å›ä¸­æ–‡ç‰ˆç³»ç»Ÿè¯´æ˜
- æ£€æµ‹åˆ°å¾·æ–‡ â†’ è¿”å›å¾·æ–‡ç‰ˆç³»ç»Ÿè¯´æ˜
- æœ€ç»ˆç­”æ¡ˆç»Ÿä¸€ç”¨å¾·æ–‡è¾“å‡º

---

### 3. é—®é¢˜åˆæ³•æ€§æ£€æŸ¥ç­–ç•¥

**åˆ¶å®šæ—¥æœŸ**: 2025-11-01  
**æ£€æŸ¥æ—¶æœº**: Intent Nodeï¼ˆæ„å›¾åˆ¤æ–­ä¹‹å‰ï¼‰

#### 3.1 ç‰¹æ®Šæƒ…å†µå¤„ç†

| é—®é¢˜ç±»å‹ | å¤„ç†æ–¹å¼ | ä¸‹ä¸€èŠ‚ç‚¹ |
|---------|---------|---------|
| å…ƒé—®é¢˜ï¼ˆ"ä½ ä¼šåšä»€ä¹ˆï¼Ÿ"ï¼‰ | è¿”å›ç³»ç»ŸåŠŸèƒ½è¯´æ˜ | END |
| å®Œå…¨ä¸ç›¸å…³ | æ‹’ç»å›ç­”ï¼Œè¯´æ˜åŸå›  | END |
| ä¿¡æ¯ä¸è¶³ | å¼•å¯¼ç”¨æˆ·è¡¥å……ä¿¡æ¯ | END |
| è¶…å‡ºæ•°æ®èŒƒå›´ | è¯´æ˜æ•°æ®èŒƒå›´ï¼Œæ‹’ç» | END |
| æ­£å¸¸é—®é¢˜ | ç»§ç»­æ„å›¾åˆ¤æ–­ | Classify/Extract |

**å®ç°ä½ç½®**: `src/graph/nodes/intent_enhanced.py`

---

### 4. å¼‚å¸¸å¤„ç†ç­–ç•¥

**åˆ¶å®šæ—¥æœŸ**: 2025-11-01

#### 4.1 å¼‚å¸¸ç±»å‹åˆ†ç±»

| å¼‚å¸¸ç±»å‹ | è¯´æ˜ | ç”¨æˆ·æç¤º |
|---------|------|---------|
| NO_MATERIAL | æœªæ‰¾åˆ°ç›¸å…³ææ–™ | æä¾›å‚æ•°åˆ†æ+è°ƒæ•´å»ºè®® |
| LLM_ERROR | LLMè°ƒç”¨å¤±è´¥ | æç¤ºé‡è¯• |
| RETRIEVAL_ERROR | æ£€ç´¢å¤±è´¥ | æç¤ºæ•°æ®åº“é—®é¢˜ |
| PARSING_ERROR | è§£æå¤±è´¥ | å¼•å¯¼é‡æ–°è¡¨è¿° |
| MILVUS_ERROR | æ•°æ®åº“è¿æ¥å¤±è´¥ | è”ç³»ç®¡ç†å‘˜ |
| UNKNOWN | æœªçŸ¥é”™è¯¯ | é€šç”¨é”™è¯¯æç¤º |

**å®ç°ä½ç½®**: `src/graph/nodes/exception_enhanced.py`

---

### 5. å­é—®é¢˜æ•°é‡æ§åˆ¶ç­–ç•¥

**åˆ¶å®šæ—¥æœŸ**: 2025-11-01

#### 5.1 æ•°é‡é™åˆ¶

- **æœ€å¤§å­é—®é¢˜æ•°**: 10ä¸ª
- **åŸå› **: æ§åˆ¶æ£€ç´¢æˆæœ¬ï¼ˆ10 Ã— top_k=5 = 50 chunksï¼‰

#### 5.2 è´¨é‡éªŒè¯

1. å»é‡ï¼ˆè§„èŒƒåŒ–åæ¯”è¾ƒï¼‰
2. æ ¼å¼æ£€æŸ¥ï¼ˆç¡®ä¿ä»¥é—®å·ç»“å°¾ï¼‰
3. é•¿åº¦æ£€æŸ¥ï¼ˆè¿‡æ»¤å¤ªçŸ­çš„é—®é¢˜ï¼‰

**å®ç°ä½ç½®**: `src/graph/nodes/decompose_enhanced.py` - `_validate_sub_questions()`

---

## å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆé€‰æ‹©æ¨¡æ¿åŒ–æ‹†è§£ä¼˜å…ˆï¼Ÿ

**å†³ç­–**: æ¨¡æ¿åŒ–æ‹†è§£ > LLMè‡ªç”±æ‹†è§£

**åŸå› **:
- âœ… ä¸€è‡´æ€§ï¼šåŒç±»é—®é¢˜æ‹†è§£æ–¹å¼ç»Ÿä¸€
- âœ… å¯æ§æ€§ï¼šé¿å…LLMéšæœºæ€§å¯¼è‡´è´¨é‡ä¸ç¨³å®š
- âœ… æ•ˆç‡ï¼šæ— éœ€LLMè°ƒç”¨ï¼Œå“åº”æ›´å¿«
- âœ… å¯ç»´æŠ¤ï¼šæ¨¡æ¿æ˜“äºè°ƒä¼˜å’Œæ‰©å±•

### 2. ä¸ºä»€ä¹ˆéœ€è¦é—®é¢˜åˆæ³•æ€§æ£€æŸ¥ï¼Ÿ

**å†³ç­–**: åœ¨æ„å›¾åˆ¤æ–­ä¹‹å‰å…ˆè¿›è¡Œåˆæ³•æ€§æ£€æŸ¥

**åŸå› **:
- âœ… æå‰æ‹¦æˆªæ— æ•ˆè¯·æ±‚ï¼ŒèŠ‚çœè®¡ç®—èµ„æº
- âœ… æä¾›æ›´å‹å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆé’ˆå¯¹æ€§å›å¤ï¼‰
- âœ… é¿å…æ— æ„ä¹‰çš„æ£€ç´¢å’Œæ€»ç»“

### 3. ä¸ºä»€ä¹ˆä½¿ç”¨å•Collection + å…ƒæ•°æ®è¿‡æ»¤ï¼Ÿ

**å†³ç­–**: å•Milvus Collection + metadata filtering > å¤šCollection

**åŸå› **:
- âœ… çµæ´»æ€§ï¼šå¯ä»¥æŒ‰ä»»æ„ç»´åº¦ç»„åˆè¿‡æ»¤
- âœ… å¯ç»´æŠ¤æ€§ï¼šåªéœ€ç»´æŠ¤ä¸€ä¸ªç´¢å¼•
- âœ… æ‰©å±•æ€§ï¼šæ·»åŠ æ–°ç»´åº¦æ— éœ€åˆ›å»ºæ–°Collection

---

## APIè§„èŒƒ

### æ¥å£å®šä¹‰

ï¼ˆå¾…è¡¥å…… - Phase 5å®ç°ï¼‰

---

## æµ‹è¯•æŒ‡å—

### å•å…ƒæµ‹è¯•

#### 1. é—®é¢˜æ‹†è§£æµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `tests/test_decompose_templates.py`

**è¿è¡Œæ–¹å¼**:
```bash
cd /Users/zhangyu/project/germany_latest/tj_germany
python src/graph/templates/decompose_templates.py
```

**æµ‹è¯•ç”¨ä¾‹**:
```python
# æµ‹è¯•1: å˜åŒ–ç±»ï¼ˆ4å¹´ï¼‰
params = {
    'time_range': {'start_year': '2015', 'end_year': '2018'},
    'parties': ['CDU/CSU', 'SPD'],
    'topics': ['éš¾æ°‘æ”¿ç­–']
}
# é¢„æœŸ: 9ä¸ªå­é—®é¢˜ï¼ˆ2å…šæ´¾Ã—4å¹´+1å¯¹æ¯”ï¼‰

# æµ‹è¯•2: æ€»ç»“ç±»ï¼ˆå•å¹´ï¼‰
params = {
    'time_range': {'start_year': '2021'},
    'parties': ['ç»¿å…š'],
    'topics': ['æ°”å€™ä¿æŠ¤']
}
# é¢„æœŸ: 1ä¸ªå­é—®é¢˜

# æµ‹è¯•3: å¯¹æ¯”ç±»ï¼ˆ3ä¸ªå¯¹è±¡ï¼‰
params = {
    'time_range': {'start_year': '2019'},
    'parties': ['CDU/CSU', 'SPD', 'FDP'],
    'topics': ['æ•°å­—åŒ–æ”¿ç­–']
}
# é¢„æœŸ: 4ä¸ªå­é—®é¢˜ï¼ˆ3ä¸ªå¯¹è±¡+1ä¸ªå¯¹æ¯”ï¼‰

# æµ‹è¯•4: è¶‹åŠ¿åˆ†æï¼ˆ11å¹´ï¼‰
params = {
    'time_range': {'start_year': '2010', 'end_year': '2020'},
    'topics': ['æ°”å€™æ”¿ç­–']
}
# é¢„æœŸ: 5ä¸ªå­é—®é¢˜ï¼ˆ4ä¸ªæ—¶é—´æ®µ+1ä¸ªè¶‹åŠ¿ï¼‰
```

#### 2. è¯­è¨€æ£€æµ‹æµ‹è¯•

**è¿è¡Œæ–¹å¼**:
```bash
python src/utils/language_detect.py
```

#### 3. åŸºç¡€é›†æˆæµ‹è¯•

**è¿è¡Œæ–¹å¼**:
```bash
python tests/test_basic_integration.py
```

### ç«¯åˆ°ç«¯æµ‹è¯•

ï¼ˆå¾…è¡¥å…… - Phase 2å®Œæˆåï¼‰

---

## éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒè¦æ±‚

- Python 3.11+
- Milvus 2.3+
- Gemini API Key

### é…ç½®æ–‡ä»¶

`.env` æ–‡ä»¶ç¤ºä¾‹:
```ini
# LLMé…ç½®
GEMINI_API_KEY=your_api_key_here
GEMINI_MODEL=gemini-2.5-pro

# Embeddingé…ç½®
EMBEDDING_MODEL=models/text-embedding-004
EMBEDDING_DIMENSION=1536

# Milvusé…ç½®
MILVUS_MODE=local  # local æˆ– cloud
MILVUS_HOST=localhost
MILVUS_PORT=19530

# æ•°æ®é…ç½®
DATA_MODE=PART  # PART æˆ– ALL
```

### éƒ¨ç½²æ­¥éª¤

ï¼ˆå¾…è¡¥å…… - Phase 5ï¼‰

---

## ç‰ˆæœ¬å†å²

### v0.1.0 (2025-11-01)

**Phase 1: Promptå·¥ç¨‹ + åŒè¯­æ”¯æŒ**
- âœ… 7ç±»æ ¸å¿ƒPrompt
- âœ… 6ç±»å…œåº•Prompt
- âœ… ä¸­å¾·åŒè¯­æ”¯æŒ
- âœ… é—®é¢˜åˆæ³•æ€§æ£€æŸ¥
- âœ… ç»†ç²’åº¦å¼‚å¸¸å¤„ç†

**Phase 2: å¤æ‚é—®é¢˜å¤„ç†ï¼ˆè¿›è¡Œä¸­ï¼‰**
- âœ… é—®é¢˜æ‹†è§£æ¨¡æ¿ï¼ˆ4ç§ï¼‰
- âœ… æ™ºèƒ½æ—¶é—´æ‹†è§£ç­–ç•¥
- ğŸ”„ EnhancedSummarizeNode
- ğŸ”„ åˆ†å±‚æ€»ç»“ç­–ç•¥

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| RAG | Retrieval Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆ |
| CoA | Chain of Agentsï¼Œæ™ºèƒ½ä½“é“¾ |
| LangGraph | LangChainçš„å›¾ç¼–æ’æ¡†æ¶ |
| Milvus | å¼€æºå‘é‡æ•°æ®åº“ |
| Embedding | æ–‡æœ¬å‘é‡åŒ– |

### B. å‚è€ƒæ–‡æ¡£

- äº§å“æ–‡æ¡£: `document/äº§å“æ–‡æ¡£.md`
- æ–¹æ¡ˆè®¾è®¡: `document/å¾·å›½è®®ä¼šæ™ºèƒ½ä½“æ–¹æ¡ˆè®¾è®¡.md`
- å®æ–½è®¡åˆ’: `IMPLEMENTATION_PLAN.md`

---

**æ–‡æ¡£ç»´æŠ¤**: æ‰€æœ‰å…³é”®ç­–ç•¥å’Œè®¾è®¡å†³ç­–éƒ½åº”åŠæ—¶æ›´æ–°åˆ°æœ¬æ–‡æ¡£

**æœ€åæ›´æ–°è€…**: AI Assistant  
**å®¡æ ¸è€…**: (å¾…å¡«å†™)

