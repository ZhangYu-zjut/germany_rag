# Phase 2 Day 4 进度总结

**日期**: 2025-11-01  
**任务**: 复杂问题处理 - 问题拆解与总结

---

## ✅ 已完成任务

### 1. 问题拆解模板设计 ✅

**文件**: `src/graph/templates/decompose_templates.py` (新增，581行)

**实现的模板**:
1. **ChangeAnalysisTemplate** - 变化类问题
   - 策略：按时间点 × 党派拆解
   - 示例："在2015-2018年，不同党派在难民政策上的立场有何变化？"
   - 拆解为：2015年CDU/CSU、2018年CDU/CSU、2015年SPD、2018年SPD + 变化对比

2. **SummaryTemplate** - 总结类问题
   - 策略：按时间/议员/党派/主题拆解
   - 智能判断是否需要按年份拆解（时间跨度>2年）

3. **ComparisonTemplate** - 对比类问题
   - 策略：为每个对比对象生成独立问题 + 对比问题
   - 示例："对比CDU/CSU和SPD在数字化政策上的立场"
   - 拆解为：CDU/CSU立场 + SPD立场 + 差异对比

4. **TrendAnalysisTemplate** - 趋势分析类问题
   - 策略：按时间段拆解（根据时间跨度自动分段）
   - 短期（≤2年）：按年拆解
   - 中期（3-5年）：按2年拆解
   - 长期（>5年）：分成4段

5. **TemplateSelector** - 模板选择器
   - 根据问题类型自动选择对应模板
   - 默认兜底为总结类模板

**测试结果**:
```
✅ 变化类：5个子问题
✅ 总结类：1个子问题
✅ 对比类：4个子问题
✅ 趋势分析：5个子问题
```

---

### 2. EnhancedDecomposeNode实现 ✅

**文件**: `src/graph/nodes/decompose_enhanced.py` (新增，457行)

**核心功能**:
1. **智能拆解判断**
   - `_need_decompose()`: 根据问题类型和参数复杂度判断是否需要拆解
   - 变化类/对比类/趋势分析：一定拆解
   - 总结类：根据时间跨度、对象数量判断
   - 事实查询：单一时间点+单一对象不拆解

2. **模板化拆解优先**
   - 使用`TemplateSelector`自动选择模板
   - 根据提取的参数生成结构化子问题

3. **LLM拆解作为backup**
   - 当模板不适用或失败时，调用LLM自由拆解
   - 使用Prompt引导LLM生成合理的子问题

4. **子问题质量验证**
   - 去重
   - 限制数量（最多10个，避免检索负担）
   - 格式规范化（确保以问号结尾）

**工作流程**:
```
问题输入
    ↓
判断是否需要拆解
    ↓
├─ 不需要 → 直接返回原问题 → 检索
└─ 需要 → 模板拆解
           ↓
       失败？→ LLM拆解
           ↓
       质量验证
           ↓
       返回子问题 → 检索
```

---

## 📁 新增文件

| 文件 | 行数 | 说明 |
|------|------|------|
| `src/graph/templates/decompose_templates.py` | 581 | 问题拆解模板库 |
| `src/graph/templates/__init__.py` | 19 | 模板模块入口 |
| `src/graph/nodes/decompose_enhanced.py` | 457 | 增强版拆解节点 |
| `PHASE2_DAY4_PROGRESS.md` | - | 本文档 |

**总计**: 4个文件，~1050行新代码

---

## 🎯 设计亮点

### 1. 模板化 vs 自由拆解

**为什么选择模板化优先？**
- ✅ 一致性：同类问题拆解方式统一
- ✅ 可控性：避免LLM随机性导致质量不稳定
- ✅ 效率：无需LLM调用，响应更快
- ✅ 可维护：模板易于调优和扩展

**什么时候使用LLM拆解？**
- 模板不适用的问题类型
- 参数提取不完整
- 模板拆解失败

### 2. 渐进式拆解策略

**变化类问题示例**:
```
原问题: "2015-2018年不同党派在难民政策上的立场变化？"

拆解策略:
1. 时间维度：起点(2015) + 终点(2018) [+ 中间点(如果跨度>3年)]
2. 对象维度：党派1 + 党派2 + ...
3. 对比维度：2015 vs 2018的变化

生成子问题:
- 2015年CDU/CSU在难民政策上的立场？
- 2018年CDU/CSU在难民政策上的立场？
- 2015年SPD在难民政策上的立场？
- 2018年SPD在难民政策上的立场？
- 从2015到2018年，不同党派立场变化有何异同？
```

### 3. 时间跨度自适应

**短期（≤2年）**:
```
2019-2020年 → 按年拆解
- 2019年的情况
- 2020年的情况
```

**中期（3-5年）**:
```
2015-2019年 → 按2年拆解
- 2015-2016年期间
- 2017-2018年期间
- 2019年
```

**长期（>5年）**:
```
2010-2020年 → 分成4段
- 2010-2012年期间
- 2013-2015年期间
- 2016-2018年期间
- 2019-2020年期间
```

---

## 🔄 下一步任务

### 任务4: EnhancedSummarizeNode（进行中）

**需求**:
1. 单子问题总结
   - 对检索到的chunks进行总结
   - 提取关键信息（speaker/statement/evidence）

2. 多子问题分层总结
   - 按维度分组（时间/党派/主题）
   - 生成结构化输出
   - 对比和变化分析

3. 模块化输出格式
   - 发言人（speaker）
   - 核心观点（statement）
   - 支撑证据（evidence）
   - 数据来源（source）

### 任务5: SummarizePrompt增强

**需要设计的Prompt**:
1. 单子问题总结Prompt
2. 多子问题分层总结Prompt
3. 变化类总结Prompt（对比2个时间点）
4. 对比类总结Prompt（对比多个对象）
5. 趋势分析总结Prompt（分析演变）

---

## 💡 自我挑战

### 挑战1：模板拆解的边界在哪里？

**回答**：
- ✅ 已覆盖：变化类、总结类、对比类、趋势分析
- ⚠️ 未覆盖：组合型问题（如"对比2015和2018年不同党派的立场变化"）
- 💡 解决方案：可以为组合型问题设计复合模板，或让LLM拆解作为兜底

### 挑战2：如何避免子问题过多？

**回答**：
- ✅ 限制数量：最多10个子问题
- ✅ 智能合并：相近年份合并（如2015-2016）
- ✅ 优先级：核心时间点（起点/终点）> 中间点
- ⚠️ 潜在问题：10个子问题 × 5个chunks = 50个chunks需要总结，LLM负担重
- 💡 优化方向：可以设置每个子问题的top_k=3，减少总chunk数

### 挑战3：拆解质量如何评估？

**回答**：
- ✅ 当前评估：子问题数量、格式规范（问号结尾）
- ⚠️ 缺失评估：语义完整性、是否覆盖原问题要点
- 💡 改进方向：可以让LLM对拆解结果进行质量打分，低于阈值则重新拆解

---

## 📊 Phase 2 整体进度

| 任务 | 状态 | 说明 |
|------|------|------|
| 问题拆解模板设计 | ✅ 完成 | 4种模板 |
| EnhancedDecomposeNode | ✅ 完成 | 智能拆解 |
| DecomposePrompt更新 | ✅ 完成 | 模板逻辑集成 |
| EnhancedSummarizeNode | 🔄 进行中 | 下一个任务 |
| SummarizePrompt更新 | 📋 待办 | - |
| 端到端测试 | 📋 待办 | - |

**预计完成时间**: Day 4下午 + Day 5上午

---

**Day 4上午工作总结** ✅  
**核心成果**: 系统化的问题拆解能力，为复杂问题处理奠定基础！💪

